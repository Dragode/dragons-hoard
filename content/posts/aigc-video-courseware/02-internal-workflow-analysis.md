+++
date = '2026-02-07T15:29:04+08:00'
draft = false
title = 'AI课件工作流深度分析报告'
tags = ['AI', 'AIGC', 'Dify', '视频生成', '工作流']
categories = ['技术调研']
series = ['AIGC视频课件生成实践']
weight = 5
+++


## 文档概述

| 属性 | 值 |
|------|-----|
| 分析对象 | AI 课件 AIGC 自动化工作流 |
| 平台 | Dify（公司内部 AI 工作流编排平台） |
| 分析日期 | 2026-02-07 |
| 分析依据 | 工作流配置文件、运行日志、调优需求文档 |

---

## 一、工作流整体架构

### 1.1 系统概览

AI 课件工作流是一个将**故事大纲**转化为**可播放视频课件**的自动化工作流，由两个子流程组成：

```
┌────────────────────────────────────────────────────────────────────────┐
│                        AI课件AIGC自动化工作流                            │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│   输入                                                                  │
│   ├── 剧本大纲（故事内容）                                               │
│   ├── 美术风格                                                          │
│   ├── 主体参考图（可选：角色/场景图片）                                    │
│   └── 自定义主体描述                                                     │
│                                                                        │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │           子流程1：主体素材生产                                │      │
│   │           (AIGC-主体素材生产.yml)                             │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              ↓                                         │
│                        主体资产库                                        │
│                    (角色/场景/道具图片)                                   │
│                              ↓                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │           子流程2：故事演绎视频生成                            │      │
│   │   (AI课件-AIGC自动化工作流-故事演绎.yml)                       │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                              ↓                                         │
│   输出                                                                  │
│   └── 剪映草稿（含视频/图片/字幕/配音）                                   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### 1.2 工作流配置文件

| 文件 | 说明 | 节点数 |
|------|------|--------|
| `AIGC-主体素材生产.yml` | 子流程1：主体素材生产 | ~15 节点 |
| `AI课件-AIGC自动化工作流-故事演绎.yml` | 子流程2：故事演绎视频生成 | ~47 节点 |

### 1.3 技术栈

| 组件 | 说明 |
|------|------|
| **工作流平台** | Dify（公司内部部署） |
| **LLM 模型** | 用于剧本分析、分镜设计、资产编排 |
| **AI 绘图** | 即梦（豆包）、悠船（Midjourney）、Gemini |
| **AI 生视频** | 图生视频模型 |
| **视频合成** | 剪映草稿输出 |

---

## 二、子流程详细分析

### 2.1 子流程1：主体素材生产

**目标**：从剧本中识别所有视觉元素，生成统一风格的参考图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         主体素材生产流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ① 输入解析                                                          │
│     ├── 剧本大纲                                                     │
│     ├── 美术风格（如：水墨风格、赛博朋克）                              │
│     └── 自定义主体图片 + 描述（可选）                                   │
│                                                                     │
│  ② 剧本分析（LLM）                                                    │
│     ├── 识别人物角色 (human_character)                                │
│     ├── 识别生物角色 (creature_character)                             │
│     ├── 识别场景 (scene)                                              │
│     └── 识别道具 (prop) - 仅核心道具                                   │
│                                                                     │
│  ③ 视觉描述生成                                                       │
│     ├── 人物：生成三视图描述（正面/侧面/背面）                           │
│     ├── 生物：生成物种原型描述（禁止拟人化）                             │
│     ├── 场景：生成空场景描述（禁止出现角色）                             │
│     └── 道具：生成单体描述                                             │
│                                                                     │
│  ④ AI绘图（并行迭代）                                                  │
│     ├── 有参考图？→ 是：直接使用 / 否：调用AI绘图                        │
│     └── 绘图引擎：即梦（默认）/ 悠船（备选）                             │
│                                                                     │
│  ⑤ 输出：主体资产库                                                    │
│     └── 每个资产：ID、类型、描述、参考图URL                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 子流程2：故事演绎视频生成

**目标**：基于主体资产库，将剧本转化为可播放的视频草稿

```
┌─────────────────────────────────────────────────────────────────────┐
│                      故事演绎视频生成流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ① 剧本创作（LLM）                                                    │
│     ├── 原著核实：查询原典，补全遗漏情节                                │
│     ├── 内容考据：核实时代背景、服化道                                  │
│     ├── 剧本扩写：每个情节点展开为完整场景                              │
│     └── 输出：场景化剧本（含转场、台词、动作）                           │
│                                                                     │
│  ② 分镜设计（LLM）                                                    │
│     ├── 将场景拆分为镜头组（shot_groups）                               │
│     └── 每个镜头定义：景别、机位角度、运镜方式、角色动作、台词、时长       │
│                                                                     │
│  ③ 资产编排（LLM）                                                    │
│     ├── 将分镜与主体资产库匹配                                         │
│     ├── 生成图像提示词 (image_prompt)                                 │
│     ├── 生成视频提示词 (video_prompt)                                 │
│     └── 选择生成方案：i2v-single / i2v-keyframe                        │
│                                                                     │
│  ④ 分镜图片/视频生成（并行迭代 × 30个镜头）                             │
│     ├── AI生图（即梦/Gemini）                                         │
│     └── AI生视频（图生视频）                                           │
│                                                                     │
│  ⑤ 剪映草稿合成                                                       │
│     ├── 创建草稿（设置画布尺寸）                                        │
│     ├── 批量添加视频/图片（按时间线排列）                                │
│     ├── 批量添加字幕（同步时间轴）                                      │
│     └── 批量添加音频（TTS配音）                                        │
│                                                                     │
│  ⑥ 输出                                                               │
│     ├── 剪映草稿URL                                                   │
│     └── 分镜数据（story_board JSON）                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、领域模型

### 3.1 核心实体

| 实体 | 类型 | 说明 |
|------|------|------|
| **human_character** | 主体资产 | 人类角色（如：小女孩、诸葛亮） |
| **creature_character** | 主体资产 | 非人类角色（如：龙、猫） |
| **scene** | 主体资产 | 场景环境（如：书房、森林） |
| **prop** | 主体资产 | 核心道具（如：火柴、魔法戒指） |

### 3.2 分镜数据结构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          分镜数据结构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  基础信息                                                           │
│  ├── idx                    镜头序号                                │
│  ├── description            镜头描述                                │
│  ├── style                  美术风格                                │
│  └── video_duration         视频时长                                │
│                                                                     │
│  资产引用                                                           │
│  ├── ref_assets             引用的主体资产ID列表                     │
│  ├── characters_in_frame    画面中的角色列表                         │
│  └── visible_fixed_elements 画面中的固定元素                         │
│                                                                     │
│  生成参数                                                           │
│  ├── generation_method      生成方案 (i2v-single/i2v-keyframe)      │
│  ├── image_prompt           首帧图像提示词                           │
│  ├── image_prompt_end       尾帧图像提示词 (仅keyframe)              │
│  └── video_prompt           视频动态提示词                           │
│                                                                     │
│  镜头语言                                                           │
│  ├── shot_type              景别 (远景/全景/中景/近景/特写)          │
│  ├── camera_angle           机位角度                                │
│  ├── camera_movement        运镜方式                                │
│  └── action                 角色动作描述                            │
│                                                                     │
│  情绪与氛围                                                         │
│  ├── scene_type             场景类型 (interior/exterior/fantasy)    │
│  ├── motion_intensity       动态强度 (low/medium/high)              │
│  └── emotion_tone           情绪基调                                │
│                                                                     │
│  配音信息                                                           │
│  ├── narration              配音文本                                │
│  ├── narration_type         配音类型 (dialogue/voiceover/narrator)  │
│  └── voice_desc             音色描述                                │
│                                                                     │
│  风格适配 (style_adaptations)                                       │
│  ├── camera_work            镜头处理                                │
│  ├── lighting               光线效果                                │
│  ├── color_grade            色彩调性                                │
│  ├── texture                画面质感                                │
│  └── environment_dynamics   环境动态                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 视频生成方案

| 方案 | 输入 | 适用场景 |
|------|------|---------|
| **i2v-single** | 1张图片 | 对话镜头、静态镜头、循环动作 |
| **i2v-keyframe** | 2张图片（首帧+尾帧） | 位置移动、姿态变化、表情转变 |

---

## 四、运行时数据分析

### 4.1 运行记录概览

分析 `#56.json` 运行日志，该运行生成了《卖火柴的小女孩》故事视频。

| 指标 | 值 |
|------|-----|
| 运行ID | bf17342e-a1a0-485d-844d-d17c728cb3ef |
| 节点执行数 | 54 |
| 分镜数量 | 约 30 个 |
| 输出 | 剪映草稿 URL |

### 4.2 分镜输出示例

```json
{
    "idx": "SG-001-01",
    "description": "建立镜头，除夕夜，大雪纷飞的19世纪欧洲街道",
    "ref_assets": ["风雪街道"],
    "generation_method": "i2v-single",
    "image_prompt": "Pixar animation style, cinematic 3D render of a deserted 19th-century European city street on a snowy New Year's Eve...",
    "video_prompt": "Fixed camera shot, the only movement is the thick, fluffy snow falling gracefully...",
    "video_duration": 5,
    "shot_type": "远景",
    "camera_movement": "固定",
    "emotion_tone": "寒冷, 孤寂, 悲伤",
    "style_adaptations": {
        "camera_work": "Fixed camera, static extreme long shot",
        "lighting": "Cinematic lighting with high contrast...",
        "color_grade": "Dominated by cold blues and whites..."
    }
}
```

### 4.3 关键性能指标

| 指标 | 当前状态 | 问题 |
|------|----------|------|
| **单次运行时间** | 约 3 小时 | 迭代效率极低 |
| **并行度** | 10 | 受 API 限流影响 |
| **重试机制** | 失败时重试 3 次 | 增加总耗时 |

---

## 五、问题分析汇总

### 5.1 调试效率问题

| 问题 | 具体表现 | 影响 | 优先级 |
|------|----------|------|--------|
| **运行时间过长** | 单次运行 3 小时 | 一天只能迭代 2 次 | P0 |
| **无法单节点调试** | 改一个提示词要从头跑 | 试错成本极高 | P0 |
| **无采样运行** | 30 个镜头必须全跑 | 验证效率低 | P0 |
| **错误定位难** | 47 个节点，迭代嵌套 3 层 | 排查时间长 | P1 |
| **日志不可读** | JSON 嵌套过深，转义字符多 | 无法直观分析 | P1 |
| **无节点缓存** | 相同输入也重新计算 | 重复浪费 | P1 |
| **版本对比困难** | 无法直观对比提示词效果 | 迭代盲目 | P2 |

### 5.2 平台能力不足问题

| 问题类别 | 涉及节点数 | 问题根因 | 优先级 |
|----------|------------|---------|--------|
| **数据提取** | ~15 个代码节点 | 缺乏字段选择器 | P0 |
| **格式转换** | ~5 个代码节点 | 缺乏类型转换节点 | P0 |
| **HTTP 转文件** | 2 个 HTTP 节点 | 工具输出非 File 类型 | P1 |
| **条件判断** | ~9 个 if-else 节点 | 缺乏 Switch-Case | P1 |
| **数据聚合** | ~4 个代码节点 | 缺乏合并/映射节点 | P1 |
| **工具输出差异** | ~3 个代码节点 | 输出 Schema 不统一 | P2 |

### 5.3 LLM 输出稳定性问题

| 问题 | 具体表现 | 影响 |
|------|----------|------|
| **格式不一致** | 有时输出 15 个分镜，有时 12 个 | 后续流程崩溃 |
| **字段缺失** | 偶尔漏掉必填字段 | 代码节点报错 |
| **内容质量波动** | 同样输入，提示词质量差异大 | 生成结果不可控 |

### 5.4 外部服务调用问题

| 问题 | 具体表现 | 影响 |
|------|----------|------|
| **超时不可控** | 即梦生图偶尔 30s+ | 整个迭代超时 |
| **API 限流** | 10 并行调用触发限流 | 批量失败 |
| **返回格式变化** | 第三方工具更新输出字段 | 代码节点崩溃 |
| **部分成功部分失败** | 10 个任务中 3 个失败 | 处理策略不清 |

---

## 六、核心矛盾分析

```
┌─────────────────────────────────────────────────────────────────┐
│                         核心矛盾                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   AIGC 模型调用特性                人工调优需求                   │
│   ──────────────────              ──────────────                │
│                                                                 │
│   • 单次调用耗时长（秒~分钟）       • 需要快速反馈                 │
│   • 结果有随机性                   • 需要多次对比                 │
│   • 多节点串联依赖                 • 想单独调某个节点              │
│   • 批量处理（30个镜头）           • 只想验证 1-2 个效果           │
│                                                                 │
│                        ↓                                        │
│                                                                 │
│            矛盾：模型慢 vs 调优要快                               │
│                                                                 │
│  解决思路：不是让模型更快，而是减少不必要的等待                     │
│  ├── 单节点调试：只跑要调的节点                                   │
│  ├── 采样运行：30 个镜头只跑 3 个验证                             │
│  ├── 节点缓存：没改的节点不重跑                                   │
│  └── 版本对比：同时跑多个版本，一次出结果                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、优化方案建议

### 7.1 优先级排序

| 优先级 | 功能 | 解决的核心问题 | 预期提升 |
|--------|------|----------------|----------|
| **P0** | 单节点调试 | 不用跑完整流程就能验证提示词 | 迭代时间 3h → 5min |
| **P0** | 采样运行 | 30 个镜头只跑 3 个验证效果 | 迭代时间 3h → 18min |
| **P1** | 节点缓存 | 上游节点不重复计算 | 节省 30-50% 时间 |
| **P1** | 日志可视化 | 树形结构、语法高亮、搜索 | 调试效率提升 |
| **P1** | 提示词版本对比 | 快速判断哪个版本更好 | 减少无效迭代 |
| **P2** | AI 优化建议 | 自动分析运行结果 | 提高迭代有效性 |

### 7.2 MVP 方案

**目标**：让调优人员从"一天 2 次迭代"提升到"一天 20 次迭代"

```
MVP 功能清单：

1. 单节点调试（最重要）
   ├── 从历史运行导入输入数据
   ├── 单独执行目标节点
   └── 查看输出，快速迭代

2. 采样运行
   ├── 迭代节点只处理前 N 个
   └── 验证通过后再完整运行

组合调优流程：

改提示词 → 单节点调试（5分钟）→ 确认 OK
    ↓
单节点 OK → 采样运行 3 个镜头（18分钟）→ 确认 OK
    ↓
采样 OK → 完整运行（3小时，可后台执行）

效果：调优验证时间从 3 小时 → 23 分钟（提升 8 倍）
```

---

## 八、附录

### 8.1 相关文档索引

| 文档 | 说明 |
|------|------|
| `AI课件生成工作流-业务逻辑.md` | 业务逻辑详细说明 |
| `AIGC工作流调优需求与方案.md` | 调优需求和方案设计 |
| `复杂工作流调试痛点与优化建议.md` | 调试痛点分析 |
| `平台能力不足问题汇总.md` | Dify 平台能力缺失分析 |

### 8.2 工作流配置文件

| 文件 | 说明 |
|------|------|
| `AIGC-主体素材生产.yml` | 子流程1 配置 |
| `AI课件-AIGC自动化工作流-故事演绎.yml` | 子流程2 配置 |

### 8.3 运行日志

| 文件 | 说明 |
|------|------|
| `log/#56.json` | 《卖火柴的小女孩》运行记录 |
| `log/#61.json` | 其他运行记录 |
| `log/prod.json` | 生产环境运行记录 |
