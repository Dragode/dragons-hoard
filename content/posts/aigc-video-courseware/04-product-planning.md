+++
date = '2026-02-07T15:29:04+08:00'
draft = false
title = 'AIGC工作流优化产品规划'
tags = ['AI', 'AIGC', 'Dify', '视频生成', '工作流']
categories = ['技术调研']
series = ['AIGC视频课件生成实践']
weight = 7
+++


## 文档概述

| 属性 | 值 |
|------|-----|
| 文档版本 | v1.0 |
| 编写日期 | 2026-02-07 |
| 输入来源 | Phase 3 问题分析与方案设计 |
| 产出目标 | MVP 产品规划、实施路线图、技术方案 |

---

## 一、产品愿景

### 1.1 愿景声明

> 打造 **AIGC 工作流调优效率工具**，让调优人员从"一天 2 次迭代"提升到"一天 20+ 次迭代"，将调优周期从 1-2 周缩短到 2-3 天。

### 1.2 目标用户

| 用户角色 | 核心诉求 | 使用频率 |
|----------|----------|----------|
| **提示词工程师** | 快速验证提示词效果，减少等待时间 | 每天高频 |
| **业务专家** | 直观查看输出质量，无需理解技术细节 | 每天中频 |
| **开发人员** | 快速定位问题，查看完整数据 | 按需低频 |

### 1.3 成功指标

| 指标 | 当前基线 | MVP 目标 | 长期目标 |
|------|----------|----------|----------|
| 单次验证时间 | 3 小时 | 23 分钟 | 10 分钟 |
| 日迭代次数 | 2 次 | 16-20 次 | 30+ 次 |
| 调优周期 | 1-2 周 | 2-3 天 | 1 天 |
| 调优人员满意度 | - | ≥ 80% | ≥ 90% |

---

## 二、产品路线图

### 2.1 三阶段规划

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          产品路线图                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase A: MVP（4-6 周）                                                  │
│  ════════════════════                                                   │
│  目标：解决最核心的调试效率问题                                           │
│  ├── 单节点调试                                                         │
│  ├── 采样运行                                                           │
│  └── 日志可视化（树形结构 + 业务视图）                                    │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  Phase B: 效率增强（4-6 周）                                             │
│  ════════════════════════                                               │
│  目标：进一步提升调试效率和用户体验                                       │
│  ├── 节点级缓存                                                         │
│  ├── 提示词版本管理                                                     │
│  ├── A/B 对比运行                                                       │
│  └── Langfuse 集成（跳转链接）                                          │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  Phase C: 平台能力增强（季度）                                           │
│  ════════════════════════════                                           │
│  目标：减少代码节点，提升开发效率                                         │
│  ├── 变量引用增强                                                       │
│  ├── 数据转换节点                                                       │
│  ├── Switch-Case 节点                                                   │
│  └── 工具输出标准化                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 里程碑计划

| 里程碑 | 时间 | 核心交付 | 验收标准 |
|--------|------|----------|----------|
| **M1: MVP Alpha** | Week 2 | 单节点调试基础版 | 能从历史运行导入数据并执行单节点 |
| **M2: MVP Beta** | Week 4 | + 采样运行 + 日志树形展示 | 完整调优流程可走通 |
| **M3: MVP Release** | Week 6 | + 业务视图 + 性能优化 | 调优人员试用满意度 ≥ 80% |
| **M4: 效率增强** | Week 10 | + 缓存 + 版本管理 | 单次验证时间 ≤ 15 分钟 |

---

## 三、MVP 功能详细设计

### 3.1 功能一：单节点调试

#### 3.1.1 功能概述

| 属性 | 说明 |
|------|------|
| 功能目标 | 允许用户单独执行某个节点，无需运行完整工作流 |
| 核心价值 | 将单次迭代时间从 3 小时缩短到 5 分钟 |
| 目标用户 | 提示词工程师、开发人员 |

#### 3.1.2 用户故事

```
作为 提示词工程师
我想要 单独运行"剧本创作"节点
以便于 快速验证提示词修改效果，无需等待 3 小时
```

#### 3.1.3 功能流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        单节点调试流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 选中目标节点                                            │   │
│  │                                                                  │   │
│  │  工作流画布                                                      │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐                  │   │
│  │  │ 输入解析  │ → │ 剧本创作  │ → │ 分镜设计  │                  │   │
│  │  └──────────┘    └─────┬────┘    └──────────┘                  │   │
│  │                        │                                        │   │
│  │                   [选中状态]                                     │   │
│  │                        │                                        │   │
│  │                   右键菜单:                                      │   │
│  │                   ├── 🔧 单节点调试                              │   │
│  │                   ├── 📋 查看历史输入                            │   │
│  │                   └── 💾 保存输入快照                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 2: 选择输入来源                                            │   │
│  │                                                                  │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │  单节点调试 - 剧本创作                               [×] │    │   │
│  │  ├─────────────────────────────────────────────────────────┤    │   │
│  │  │                                                         │    │   │
│  │  │  输入来源:                                              │    │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │    │   │
│  │  │  │ ○ 从历史运行导入                                 │   │    │   │
│  │  │  │   ├── #56 (2026-02-07 14:30) 卖火柴的小女孩     │   │    │   │
│  │  │  │   ├── #55 (2026-02-06 10:15) 井底之蛙           │   │    │   │
│  │  │  │   └── #54 (2026-02-05 16:20) 龟兔赛跑           │   │    │   │
│  │  │  │                                                  │   │    │   │
│  │  │  │ ○ 从快照加载                                     │   │    │   │
│  │  │  │   └── snapshot_20260207_1430 (手动保存)         │   │    │   │
│  │  │  │                                                  │   │    │   │
│  │  │  │ ○ 手动输入 JSON                                  │   │    │   │
│  │  │  └─────────────────────────────────────────────────┘   │    │   │
│  │  │                                                         │    │   │
│  │  │                    [取消]  [下一步]                      │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 3: 编辑输入 & 执行                                         │   │
│  │                                                                  │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │  输入数据预览                                [编辑] [执行] │    │   │
│  │  ├─────────────────────────────────────────────────────────┤    │   │
│  │  │  {                                                       │    │   │
│  │  │    "story_outline": "从前有一个卖火柴的小女孩...",       │    │   │
│  │  │    "art_style": "皮克斯3D动画风格",                      │    │   │
│  │  │    "assets": [...],                                      │    │   │
│  │  │    "config": {...}                                       │    │   │
│  │  │  }                                                       │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 4: 查看输出结果                                            │   │
│  │                                                                  │   │
│  │  执行状态: ✅ 成功 (耗时 45s)                                     │   │
│  │                                                                  │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │  输出                                   [业务视图] [JSON] │    │   │
│  │  ├─────────────────────────────────────────────────────────┤    │   │
│  │  │                                                         │    │   │
│  │  │  生成了 12 个场景:                                       │    │   │
│  │  │  ├── 场景1: 除夕夜，大雪纷飞的街道                       │    │   │
│  │  │  ├── 场景2: 小女孩蜷缩在墙角                            │    │   │
│  │  │  └── ...                                                │    │   │
│  │  │                                                         │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  │                                                                  │   │
│  │  [再次执行]  [修改提示词]  [保存输入快照]                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.1.4 技术方案

**数据模型**

```sql
-- 节点输入快照表
CREATE TABLE workflow_node_snapshots (
    id VARCHAR(36) PRIMARY KEY,
    workflow_id VARCHAR(36) NOT NULL,
    node_id VARCHAR(36) NOT NULL,
    run_id VARCHAR(36),           -- 关联的运行记录（可选）
    name VARCHAR(256),            -- 快照名称
    input_data JSON NOT NULL,     -- 输入数据
    output_data JSON,             -- 输出数据（可选）
    created_by VARCHAR(36),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_workflow_node (workflow_id, node_id),
    INDEX idx_run (run_id)
);
```

**API 设计**

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/workflows/{id}/nodes/{node_id}/snapshots` | 获取节点快照列表 |
| POST | `/workflows/{id}/nodes/{node_id}/snapshots` | 保存节点快照 |
| GET | `/workflows/{id}/runs/{run_id}/nodes/{node_id}/input` | 获取历史运行的节点输入 |
| POST | `/workflows/{id}/nodes/{node_id}/debug` | 执行单节点调试 |

**执行单节点 API 详情**

```
POST /workflows/{workflow_id}/nodes/{node_id}/debug

Request:
{
    "input_data": {...},           // 输入数据
    "use_cache": false,            // 是否使用缓存
    "timeout": 120                 // 超时时间（秒）
}

Response:
{
    "status": "success",           // success / failed / timeout
    "duration_ms": 45000,          // 执行耗时
    "output_data": {...},          // 输出数据
    "tokens_used": 9777,           // Token 消耗（LLM 节点）
    "error": null                  // 错误信息
}
```

---

### 3.2 功能二：采样运行

#### 3.2.1 功能概述

| 属性 | 说明 |
|------|------|
| 功能目标 | 允许用户只处理迭代节点的前 N 个数据项 |
| 核心价值 | 将端到端验证时间从 3 小时缩短到 18 分钟 |
| 目标用户 | 提示词工程师、业务专家 |

#### 3.2.2 用户故事

```
作为 提示词工程师
我想要 只生成前 3 个镜头的视频
以便于 快速验证整体效果，确认无误后再完整运行
```

#### 3.2.3 功能设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         采样运行配置界面                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  运行设置                                                    [×]  │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  运行模式                                                        │ │
│  │  ────────                                                        │ │
│  │  ○ 完整运行                                                      │ │
│  │    处理全部 30 个镜头，预估耗时 ~3 小时                           │ │
│  │                                                                   │ │
│  │  ● 采样运行                                                      │ │
│  │    仅处理部分数据，快速验证效果                                   │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  采样配置                                                   │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │                                                             │ │ │
│  │  │  采样数量: [ 3 ▼ ] 个                                       │ │ │
│  │  │                                                             │ │ │
│  │  │  采样方式:                                                  │ │ │
│  │  │  ● 前 N 个     从头开始取                                   │ │ │
│  │  │  ○ 随机采样    随机选取 N 个                                │ │ │
│  │  │  ○ 指定索引    手动指定 [1, 5, 10]                          │ │ │
│  │  │                                                             │ │ │
│  │  │  应用范围:                                                  │ │ │
│  │  │  ☑ 遍历生成分镜图片 (30 → 3)                                │ │ │
│  │  │  ☑ 遍历生成分镜视频 (30 → 3)                                │ │ │
│  │  │  ☐ 遍历生成主体素材 (4 → 4，不采样)                         │ │ │
│  │  │                                                             │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  预估对比                                                   │ │ │
│  │  ├─────────────────────────────────────────────────────────────┤ │ │
│  │  │           完整运行          采样运行          节省           │ │ │
│  │  │  时间:    ~3 小时           ~18 分钟         90%            │ │ │
│  │  │  Token:   ~400K             ~40K             90%            │ │ │
│  │  │  API调用: ~60 次            ~6 次            90%            │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  ⚠️ 提示：采样运行的输出仅包含部分数据，不可直接用于生产          │ │
│  │                                                                   │ │
│  │                              [取消]  [开始采样运行]               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.4 技术方案

**运行参数扩展**

```python
# 工作流运行参数
class WorkflowRunParams:
    # 采样模式
    sample_mode: str = "full"  # full / sample
    sample_count: int = 3
    sample_strategy: str = "first_n"  # first_n / random / specified
    sample_indices: List[int] = None  # 仅 specified 模式

    # 采样范围（指定哪些迭代节点应用采样）
    sample_nodes: List[str] = None  # None 表示所有迭代节点
```

**迭代节点执行逻辑修改**

```python
def execute_iteration_node(node, items, run_params):
    # 判断是否应用采样
    if run_params.sample_mode == "sample" and node.id in run_params.sample_nodes:
        items = apply_sampling(items, run_params)

    # 执行迭代
    results = []
    for item in items:
        result = execute_single_item(node, item)
        results.append(result)

    return results

def apply_sampling(items, run_params):
    if run_params.sample_strategy == "first_n":
        return items[:run_params.sample_count]
    elif run_params.sample_strategy == "random":
        return random.sample(items, min(len(items), run_params.sample_count))
    elif run_params.sample_strategy == "specified":
        return [items[i] for i in run_params.sample_indices if i < len(items)]
```

---

### 3.3 功能三：日志可视化

#### 3.3.1 功能概述

| 属性 | 说明 |
|------|------|
| 功能目标 | 将不可读的 JSON 日志转化为直观可用的结构化视图 |
| 核心价值 | 提升问题排查效率，降低理解门槛 |
| 目标用户 | 所有用户 |

#### 3.3.2 业务视图 vs 开发视图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        视图模式切换                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  主体素材生成 ✅ 成功                                        [×]  │ │
│  │  耗时: 2m 2.8s                                                    │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  视图模式:  [📝 业务视图]  [🔧 开发视图]                          │ │
│  │             ~~~~~~~~~~~~                                          │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│                              ↓                                          │
│                                                                         │
│  ┌─────────────────────────┐      ┌─────────────────────────┐         │
│  │     业务视图（默认）      │      │       开发视图          │         │
│  ├─────────────────────────┤      ├─────────────────────────┤         │
│  │                         │      │                         │         │
│  │  📥 输入                 │      │  🔍 搜索字段...          │         │
│  │  ──────                 │      │                         │         │
│  │  故事内容:              │      │  ┌─ 输入 ─────────────┐ │         │
│  │  "从前有一只小青蛙..."   │      │  │  ▼ { 5 Items }     │ │         │
│  │                         │      │  │    "input": "..."  │ │         │
│  │  美术风格:              │      │  │    "art_style": ...│ │         │
│  │  国风手绘风，Q版古风风格  │      │  │    ▶ "config": {}  │ │         │
│  │                         │      │  └────────────────────┘ │         │
│  │  📤 生成的素材           │      │                         │         │
│  │  ──────────             │      │  ┌─ 输出 ─────────────┐ │         │
│  │  角色 (2个)             │      │  │  ▼ { 5 Items }     │ │         │
│  │  ┌─────┐ ┌─────┐       │      │  │    ▶ "text": ...   │ │         │
│  │  │ 🖼️  │ │ 🖼️  │       │      │  │    ▼ "result": []  │ │         │
│  │  │小青蛙│ │大海龟│       │      │  │      ├─ 0: {...}   │ │         │
│  │  └─────┘ └─────┘       │      │  │      └─ 1: {...}   │ │         │
│  │                         │      │  └────────────────────┘ │         │
│  │  场景 (2个)             │      │                         │         │
│  │  ┌─────┐ ┌─────┐       │      │  Token: 133.1K          │         │
│  │  │ 🖼️  │ │ 🖼️  │       │      │  费用: ¥2.36            │         │
│  │  │古井 │ │大海 │       │      │                         │         │
│  │  └─────┘ └─────┘       │      │  [在 Langfuse 中查看]   │         │
│  │                         │      │                         │         │
│  └─────────────────────────┘      └─────────────────────────┘         │
│                                                                         │
│  业务视图特点:                      开发视图特点:                        │
│  • 隐藏技术字段                     • 完整 JSON 数据                    │
│  • 图片缩略图预览                   • 树形可折叠结构                    │
│  • 卡片式展示资产                   • 语法高亮着色                      │
│  • Markdown 渲染文本                • 字段搜索功能                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.3 JSON 树形结构展示

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        JSON 树形结构展示                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输出 📋                                      [展开全部] [折叠全部]      │
│  ────────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ▼ { 5 Items }                                                          │
│  │                                                                      │
│  ├─ "text": "{"result_assets": [{..."  ⚠️ 已解析嵌套JSON                │
│  │    │                                                                 │
│  │    └─ ▼ "result_assets": [ 4 Items ]                                │
│  │         │                                                            │
│  │         ├─ 0: { 8 Items }                                           │
│  │         │    ├─ "id": "小青蛙"                                       │
│  │         │    ├─ "type": "creature_character"                        │
│  │         │    ├─ "description": "一只生活在井底的Q版小青蛙..."         │
│  │         │    ├─ ▶ "details": { 7 Items }    ← 点击展开               │
│  │         │    ├─ "visual_profile": "国风手绘风..."                    │
│  │         │    ├─ ▶ "ref_file": { 12 Items }                          │
│  │         │    └─ "ref_url": "https://ai-hub-api..." 📋               │
│  │         │                                                            │
│  │         ├─ 1: { 8 Items } "大海龟"                                   │
│  │         ├─ 2: { 8 Items } "古井底部"                                 │
│  │         └─ 3: { 8 Items } "幻想中的大海"                             │
│  │                                                                      │
│  ├─ ▶ "files": [ 1 Items ]                                             │
│  ├─ ▶ "json": [ 1 Items ]                                              │
│  └─ ▶ "art_style_ref_file": [ 1 Items ]                                │
│                                                                         │
│  ────────────────────────────────────────────────────────────────────   │
│  语法高亮: 键名=蓝色  字符串=绿色  数字=橙色  布尔=紫色  null=灰色        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.4 技术实现建议

| 组件 | 推荐方案 | 说明 |
|------|----------|------|
| 树形组件 | react-json-view 或自研 | 支持折叠、搜索、复制 |
| 语法高亮 | CSS 变量 | 与 Dify 主题一致 |
| 嵌套解析 | 递归检测 + 按需解析 | 避免性能问题 |
| 虚拟滚动 | react-window | 大数据量时保证性能 |

---

## 四、数据分层架构

### 4.1 Dify + Langfuse 职责边界

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       数据查看分层架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Layer 1: 业务视图 (Dify)                                         │ │
│  │  ═════════════════════════                                        │ │
│  │  用户: 业务专家、提示词工程师                                      │ │
│  │  内容: 提示词、输出内容(Markdown渲染)、图片预览                    │ │
│  │  场景: 日常调优、验证输出质量                                      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Layer 2: 开发视图 (Dify)                                         │ │
│  │  ═════════════════════════                                        │ │
│  │  用户: 开发人员                                                    │ │
│  │  内容: 单节点完整输入/输出 JSON、变量值                            │ │
│  │  场景: 排查单节点问题、验证数据格式                                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              │                                          │
│                              ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Layer 3: 全链路追踪 (Langfuse)                                   │ │
│  │  ═════════════════════════════                                    │ │
│  │  用户: 开发人员、运维、技术负责人                                  │ │
│  │  内容: 全链路 trace、性能分析、成本归因、历史对比                  │ │
│  │  场景: 性能优化、成本分析、跨节点问题排查                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 职责分配

| 能力 | Dify 业务视图 | Dify 开发视图 | Langfuse |
|------|---------------|---------------|----------|
| 查看提示词 | ✅ 主要 | ✅ 完整 | ✅ 有 |
| 查看输出内容 | ✅ Markdown 渲染 | ✅ JSON 原始 | ✅ 有 |
| 图片预览 | ✅ 主要 | ✅ 有 | ❌ 无 |
| 单节点 JSON | ❌ 隐藏 | ✅ 主要 | ✅ 有 |
| Token 统计 | ❌ 隐藏 | ⚪ 可选 | ✅ 主要 |
| 费用分析 | ❌ 隐藏 | ⚪ 可选 | ✅ 主要 |
| 跨节点数据流 | ❌ 无 | ❌ 无 | ✅ 主要 |
| 历史对比 | ❌ 无 | ❌ 无 | ✅ 主要 |

### 4.3 Langfuse 跳转集成

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              [×]  │
│  耗时: 2m 2.810s                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 快捷操作 ────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  [📊 在 Langfuse 中查看]  [📋 复制 Trace ID]                       │ │
│  │                                                                    │ │
│  │  Trace ID: abc123-def456-...                                       │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 五、实施计划

### 5.1 Phase A: MVP 实施计划（6 周）

#### Week 1-2: 单节点调试基础版

| 任务 | 负责 | 产出 |
|------|------|------|
| 数据库表设计 | 后端 | `workflow_node_snapshots` 表 |
| 历史运行输入获取 API | 后端 | GET `/runs/{id}/nodes/{node_id}/input` |
| 单节点执行 API | 后端 | POST `/nodes/{node_id}/debug` |
| 节点右键菜单 | 前端 | "单节点调试"入口 |
| 输入来源选择弹窗 | 前端 | 历史运行列表 UI |

#### Week 3-4: 采样运行 + 日志树形展示

| 任务 | 负责 | 产出 |
|------|------|------|
| 运行参数扩展 | 后端 | `sample_mode` 等参数 |
| 迭代节点采样逻辑 | 后端 | `apply_sampling` 函数 |
| 运行设置弹窗 | 前端 | 采样配置 UI |
| JSON 树形组件 | 前端 | 可折叠、可搜索 |
| 语法高亮 | 前端 | CSS 变量配置 |

#### Week 5-6: 业务视图 + 集成测试

| 任务 | 负责 | 产出 |
|------|------|------|
| 业务视图渲染 | 前端 | 卡片式资产展示 |
| 视图切换 | 前端 | Tab 切换 UI |
| 嵌套 JSON 自动解析 | 前端 | 递归检测逻辑 |
| 端到端测试 | QA | 测试用例 + 测试报告 |
| 用户试用 | PM | 用户反馈收集 |

### 5.2 文件清单

#### 后端（api/）

| 文件 | 说明 |
|------|------|
| `models/workflow_node_snapshot.py` | 快照数据模型 |
| `controllers/console/app/workflow_debug.py` | 单节点调试 API |
| `services/workflow/debug_service.py` | 调试服务层 |
| `core/workflow/nodes/iteration/executor.py` | 迭代节点采样逻辑修改 |

#### 前端（web/）

| 文件 | 说明 |
|------|------|
| `app/components/workflow/node-debug-modal/` | 单节点调试弹窗 |
| `app/components/workflow/run-settings-modal/` | 运行设置弹窗 |
| `app/components/base/json-tree/` | JSON 树形组件 |
| `app/components/workflow/trace-view/` | 追踪日志视图重构 |

---

## 六、Phase B & C 规划预览

### 6.1 Phase B: 效率增强（预计 Week 7-12）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 节点级缓存 | 相同输入复用输出 | P1 |
| 提示词版本管理 | 版本历史、备注、回滚 | P1 |
| A/B 对比运行 | 两个版本并行运行，结果对比 | P1 |
| Langfuse 深度集成 | 一键跳转 + Trace ID 关联 | P1 |

### 6.2 Phase C: 平台能力增强（预计 Q2）

| 功能 | 说明 | 可减少代码节点 |
|------|------|---------------|
| 变量引用增强 | `{{var.field}}`、`{{var[0]}}` | ~10 个 |
| 数据转换节点 | 类型转换、JSON 序列化 | ~5 个 |
| Switch-Case 节点 | 根据变量值路由 | ~9 个 if-else |
| 工具输出标准化 | 统一生成类工具输出 Schema | ~3 个 |

---

## 七、风险管理

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 单节点调试技术复杂度超预期 | 中 | 延期 | 先实现简化版（仅支持从历史运行导入） |
| 采样运行可能影响数据一致性 | 低 | 质量 | 明确标记采样结果，区分完整运行 |
| JSON 树形组件性能问题 | 中 | 体验 | 使用虚拟滚动，限制展开层级 |
| 用户习惯改变困难 | 中 | 推广 | 引导式教程 + 效率对比演示 |

---

## 八、附录

### 8.1 关键文档引用

| 文档 | 说明 |
|------|------|
| `03-problem-analysis.md` | Phase 3 问题分析 |
| `references/AIGC工作流调优需求与方案.md` | 完整调优需求 |
| `docs/aigc/aigc-node-detailed-design.md` | AIGC 节点详细设计（可参考） |
| `docs/aigc/artifacts/aigc-unified-api-spec.md` | AIGC 统一 API 规范（可参考） |

### 8.2 相关资源

| 资源 | 用途 |
|------|------|
| Dify 源码 | API 实现参考 |
| Langfuse 文档 | 集成方案参考 |
| react-json-view | JSON 树形组件参考 |
