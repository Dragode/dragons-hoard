+++
date = '2026-02-07T15:29:04+08:00'
draft = false
title = '参考：AIGC工作流调优需求与方案'
tags = ['AI', 'AIGC', 'Dify', '视频生成', '工作流']
categories = ['技术调研']
series = ['AIGC视频课件生成实践']
weight = 111
+++


## 用户痛点分析

从截图和描述中，识别出以下核心痛点：

| 痛点 | 具体表现 | 影响 |
|------|----------|------|
| **运行时间过长** | 单次运行 3 小时 | 迭代效率极低，一天只能跑几轮 |
| **调试体验差** | 需要完整跑完才能看结果 | 提示词小改动也要等 3 小时 |
| **版本对比困难** | 无法直观对比不同提示词的效果 | 难以判断优化是否有效 |
| **定位问题难** | 多节点串联，不知道哪里出问题 | 排查成本高 |
| **重复执行浪费** | 改一个节点要从头跑 | 前置节点重复计算 |

---

## 运行时间长对人工调优的影响分析

### 背景说明

AIGC 工作流运行时间长是**固有特性**，不是 bug：
- LLM 推理本身耗时（秒级~分钟级）
- 生图/生视频模型更慢（分钟级）
- 多节点串联 + 迭代循环（30个镜头）→ 时间叠加

**核心问题不是"如何让模型更快"，而是"长时间运行如何影响人工调优效率"。**

### 1. 调优迭代周期分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    单次调优迭代周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  修改提示词 → 运行工作流 → 查看结果 → 分析问题 → 修改提示词        │
│      5min        3h          15min       30min       5min       │
│                                                                 │
│  ═══════════════════════════════════════════════════════════    │
│                      单次迭代 ≈ 4 小时                           │
│                                                                 │
│  一个工作日（8h）最多完成 2 次完整迭代                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 具体影响维度

| 影响维度 | 具体问题 | 严重程度 |
|----------|----------|----------|
| **反馈延迟** | 改完提示词要等 3 小时才知道效果 | ⭐⭐⭐⭐⭐ |
| **上下文丢失** | 等待期间做其他事，回来时忘了改了什么 | ⭐⭐⭐⭐ |
| **试错成本高** | 一个小改动验证失败 = 浪费 3 小时 | ⭐⭐⭐⭐⭐ |
| **对比困难** | 无法快速对比 A/B 两个版本的效果 | ⭐⭐⭐⭐ |
| **心理压力** | 不敢轻易尝试，怕浪费时间 | ⭐⭐⭐ |
| **知识积累慢** | 迭代次数少，经验积累缓慢 | ⭐⭐⭐ |

### 3. 调优人员的实际工作模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    调优人员一天的工作流                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  09:00  启动第一次运行，修改了"剧本创作"提示词                    │
│         │                                                       │
│         │ ← 等待 3 小时（做其他工作/摸鱼）                       │
│         │                                                       │
│  12:00  运行完成，查看结果                                       │
│         发现问题：场景太少，转场不自然                            │
│         │                                                       │
│  12:30  午饭                                                     │
│         │                                                       │
│  14:00  修改提示词，启动第二次运行                                │
│         │                                                       │
│         │ ← 等待 3 小时                                         │
│         │                                                       │
│  17:00  运行完成，查看结果                                       │
│         发现：场景多了，但角色描述不一致                          │
│         │                                                       │
│  17:30  记录问题，明天继续...                                    │
│                                                                 │
│  ═══════════════════════════════════════════════════════════    │
│  一天产出：2 次迭代，发现 2 个问题，解决 0 个                     │
│  ═══════════════════════════════════════════════════════════    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 问题根源分析

```
┌─────────────────────────────────────────────────────────────────┐
│                      问题根源拆解                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Q: 为什么调优必须跑完整工作流？                                  │
│                                                                 │
│  原因 1：节点间有依赖                                            │
│  ├── 剧本创作 → 分镜设计 → 资产编排 → 生图生视频                 │
│  └── 改了"剧本创作"，下游节点都要重跑                            │
│                                                                 │
│  原因 2：缺乏隔离调试能力                                        │
│  ├── 无法只跑单个节点                                           │
│  └── 无法 mock 上游输出                                         │
│                                                                 │
│  原因 3：迭代节点放大耗时                                        │
│  ├── 30 个镜头 × 每个 2-3 分钟 = 60-90 分钟                     │
│  └── 即使只想验证 1 个镜头的效果，也要等全部跑完                  │
│                                                                 │
│  原因 4：无缓存机制                                              │
│  └── 相同输入也要重新计算                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5. 量化影响

| 指标 | 当前状态 | 理想状态 | 差距 |
|------|----------|----------|------|
| 单次迭代时间 | 3-4 小时 | 5-15 分钟 | 12-48x |
| 日迭代次数 | 2 次 | 20-30 次 | 10-15x |
| 调优周期（达到满意效果） | 1-2 周 | 1-2 天 | 5-10x |
| 试错心理门槛 | 高（不敢乱改） | 低（随便试） | - |

### 6. 核心矛盾

```
┌─────────────────────────────────────────────────────────────────┐
│                         核心矛盾                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   AIGC 模型调用                    人工调优需求                   │
│   ──────────────                  ──────────────                │
│                                                                 │
│   • 单次调用耗时长（秒~分钟）       • 需要快速反馈                 │
│   • 结果有随机性                   • 需要多次对比                 │
│   • 多节点串联                     • 想单独调某个节点              │
│   • 批量处理（30个镜头）           • 只想验证1-2个效果             │
│                                                                 │
│                        ↓                                        │
│                                                                 │
│            矛盾：模型慢 vs 调优要快                               │
│                                                                 │
│  解决思路：不是让模型更快，而是减少不必要的等待                     │
│  ├── 单节点调试：只跑要调的节点                                   │
│  ├── 采样运行：30个镜头只跑3个验证                                │
│  ├── 节点缓存：没改的节点不重跑                                   │
│  └── 版本对比：同时跑多个版本，一次出结果                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 需求整理

### 一、单节点调试能力

```
┌─────────────────────────────────────────────────────────────────┐
│                        单节点调试需求                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 单节点独立运行                                                │
│     ├── 选中任意节点，注入 mock 输入，单独执行                      │
│     ├── 无需等待上游节点完成                                       │
│     └── 快速验证提示词效果                                        │
│                                                                 │
│  2. 从某节点重新运行                                              │
│     ├── 复用已完成节点的输出（截图中已有"由此重新执行"按钮）          │
│     ├── 仅重跑下游节点                                            │
│     └── 节省前置节点的计算时间                                     │
│                                                                 │
│  3. 节点输入/输出快照                                              │
│     ├── 保存节点的输入输出数据                                     │
│     ├── 支持导入历史快照作为 mock 数据                              │
│     └── 方便复现问题                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 二、提示词版本管理与对比

```
┌─────────────────────────────────────────────────────────────────┐
│                     提示词版本管理需求                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 提示词版本历史                                                │
│     ├── 每次保存自动生成版本号（v1, v2, v3...）                    │
│     ├── 支持版本备注（如："增加考据要求"）                          │
│     └── 版本回滚                                                 │
│                                                                 │
│  2. A/B 对比运行                                                 │
│     ├── 选择 2-3 个提示词版本                                     │
│     ├── 相同输入，并行运行                                        │
│     └── 结果并排展示                                              │
│                                                                 │
│  3. 效果对比视图                                                  │
│     ├── Diff 视图：高亮提示词变更部分                              │
│     ├── 输出对比：同一输入下不同版本的输出                          │
│     └── 质量评分：Token 消耗、耗时、人工评分                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 三、运行效率优化

```
┌─────────────────────────────────────────────────────────────────┐
│                      运行效率优化需求                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 节点级缓存                                                    │
│     ├── 相同输入 → 复用上次输出                                   │
│     ├── 缓存 key = hash(节点ID + 输入数据 + 提示词)                │
│     └── 手动清除缓存选项                                          │
│                                                                 │
│  2. 并行度提升                                                    │
│     ├── 当前：并行度 10（截图显示）                                │
│     ├── 支持调整并行度                                            │
│     └── 按节点类型设置（生图/生视频 并行度不同）                     │
│                                                                 │
│  3. 增量运行                                                      │
│     ├── 检测哪些节点输入有变化                                     │
│     ├── 仅重跑变化的节点及其下游                                   │
│     └── 类似 Make 的增量构建                                      │
│                                                                 │
│  4. 采样运行                                                      │
│     ├── 只处理前 N 个镜头（如前 3 个）                             │
│     ├── 快速验证整体流程                                          │
│     └── 正式运行时再处理全部                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 四、AI 辅助优化

```
┌─────────────────────────────────────────────────────────────────┐
│                      AI 辅助优化需求                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 自动分析运行结果                                              │
│     ├── 识别失败/重试节点                                         │
│     ├── 分析耗时瓶颈                                              │
│     └── 生成优化建议                                              │
│                                                                 │
│  2. 提示词优化建议                                                │
│     ├── 基于输出质量，建议提示词调整方向                            │
│     ├── 对比历史版本，总结什么改动有效                              │
│     └── 自动生成优化后的提示词草案                                  │
│                                                                 │
│  3. 优化总结报告                                                  │
│     ├── 本次调优改了什么                                          │
│     ├── 效果对比（耗时、Token、质量）                               │
│     └── 下一步优化建议                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 优化方案设计

### 方案一：单节点调试模式（优先级 P0）

**目标**：将单次迭代时间从 3 小时缩短到 5 分钟

```
┌─────────────────────────────────────────────────────────────────┐
│                        单节点调试模式                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户操作流程：                                                   │
│                                                                 │
│  ① 选中目标节点（如"剧本创作"）                                    │
│  ② 点击"单节点调试"按钮                                          │
│  ③ 选择输入来源：                                                │
│     ├── [历史运行] 从运行记录 #56 导入                            │
│     ├── [手动输入] 粘贴 JSON                                     │
│     └── [快照] 从保存的快照加载                                   │
│  ④ 运行节点                                                      │
│  ⑤ 查看输出，调整提示词，重复 ④                                   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  技术实现：                                                       │
│                                                                 │
│  - 节点输入快照表 (workflow_node_snapshots)                       │
│    ├── id, workflow_id, node_id, run_id                         │
│    ├── input_data (JSON), output_data (JSON)                    │
│    └── created_at                                               │
│                                                                 │
│  - API: POST /workflows/{id}/nodes/{node_id}/debug              │
│    ├── 请求体: { input_data: {...} }                            │
│    └── 响应: 节点执行结果                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 方案二：提示词版本对比（优先级 P0）

**目标**：直观对比不同提示词版本的效果

```
┌─────────────────────────────────────────────────────────────────┐
│                      提示词版本对比界面                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  节点: 剧本创作                                    [×]  │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │  版本选择:  [v3 当前] vs [v2 昨天] vs [v1 初版]          │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                         │    │
│  │  ┌─────────────┬─────────────┬─────────────┐           │    │
│  │  │    v3       │     v2      │     v1      │           │    │
│  │  ├─────────────┼─────────────┼─────────────┤           │    │
│  │  │ [提示词]    │ [提示词]    │ [提示词]    │           │    │
│  │  │ 增加了      │ 基础版本    │ 初版        │           │    │
│  │  │ +考据要求   │             │             │           │    │
│  │  │ +转场规范   │             │             │           │    │
│  │  ├─────────────┼─────────────┼─────────────┤           │    │
│  │  │ [输出预览]  │ [输出预览]  │ [输出预览]  │           │    │
│  │  │ 场景数: 12  │ 场景数: 8   │ 场景数: 5   │           │    │
│  │  │ Token: 9777 │ Token: 6200 │ Token: 3100 │           │    │
│  │  │ 耗时: 45s   │ 耗时: 32s   │ 耗时: 18s   │           │    │
│  │  └─────────────┴─────────────┴─────────────┘           │    │
│  │                                                         │    │
│  │  [Diff 视图]  [并排视图]  [评分对比]                     │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**数据模型**：

```python
# 提示词版本表
class PromptVersion(db.Model):
    id = db.Column(db.String(36), primary_key=True)
    workflow_id = db.Column(db.String(36))
    node_id = db.Column(db.String(36))
    version = db.Column(db.Integer)  # 版本号
    prompt_content = db.Column(db.Text)  # 提示词内容
    remark = db.Column(db.String(256))  # 版本备注
    created_by = db.Column(db.String(36))
    created_at = db.Column(db.DateTime)

# 版本运行结果表
class PromptVersionRun(db.Model):
    id = db.Column(db.String(36), primary_key=True)
    version_id = db.Column(db.String(36))
    input_snapshot_id = db.Column(db.String(36))  # 输入快照
    output_data = db.Column(db.JSON)
    tokens_used = db.Column(db.Integer)
    duration_ms = db.Column(db.Integer)
    quality_score = db.Column(db.Float)  # 人工评分
    created_at = db.Column(db.DateTime)
```

### 方案三：节点级缓存（优先级 P1）

**目标**：避免重复计算，缩短总运行时间

```
┌─────────────────────────────────────────────────────────────────┐
│                        节点缓存机制                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  缓存策略：                                                      │
│                                                                 │
│  cache_key = hash(                                              │
│      node_id +                                                  │
│      prompt_version +                                           │
│      serialize(input_data) +                                    │
│      model_name                                                 │
│  )                                                              │
│                                                                 │
│  命中条件：                                                      │
│  ├── 节点 ID 相同                                               │
│  ├── 提示词版本相同                                              │
│  ├── 输入数据相同                                                │
│  └── 模型相同                                                   │
│                                                                 │
│  缓存位置：                                                      │
│  ├── L1: 内存缓存（当前会话）                                    │
│  ├── L2: Redis（跨会话）                                        │
│  └── L3: 数据库（持久化）                                        │
│                                                                 │
│  UI 交互：                                                       │
│  ├── 节点角标显示 [缓存] 表示命中缓存                             │
│  ├── 右键菜单 → 清除此节点缓存                                   │
│  └── 全局设置 → 启用/禁用缓存                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 方案四：采样运行模式（优先级 P1）

**目标**：快速验证整体流程，不必等全部完成

```
┌─────────────────────────────────────────────────────────────────┐
│                        采样运行模式                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  场景：迭代循环节点有 30 个镜头，但只想先验证 3 个                   │
│                                                                 │
│  操作：                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  运行设置                                          [×]  │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                         │    │
│  │  运行模式:                                               │    │
│  │  ○ 完整运行（处理全部数据）                               │    │
│  │  ● 采样运行（仅处理部分数据）                              │    │
│  │                                                         │    │
│  │  采样设置:                                               │    │
│  │  ├── 采样数量: [3] 个                                    │    │
│  │  ├── 采样方式: ○ 前 N 个  ● 随机  ○ 指定索引              │    │
│  │  └── 应用于迭代节点: ☑ 遍历生成分镜                       │    │
│  │                                                         │    │
│  │  预估时间:                                               │    │
│  │  ├── 完整运行: ~3 小时                                   │    │
│  │  └── 采样运行: ~18 分钟                                  │    │
│  │                                                         │    │
│  │              [取消]  [开始运行]                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 方案五：AI 优化助手（优先级 P2）

**目标**：AI 辅助分析运行结果，给出优化建议

```
┌─────────────────────────────────────────────────────────────────┐
│                       AI 优化助手                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  触发场景：                                                      │
│  ├── 运行完成后自动分析                                          │
│  ├── 用户点击"Ask AI"按钮（截图左下角已有）                       │
│  └── 对比多次运行结果时                                          │
│                                                                 │
│  分析维度：                                                      │
│                                                                 │
│  1. 耗时分析                                                     │
│     ├── 识别耗时最长的节点                                       │
│     ├── 分析是否可以优化（如降低并行度的节点）                      │
│     └── 建议：是否可以用更快的模型替代                             │
│                                                                 │
│  2. 失败分析                                                     │
│     ├── 统计重试次数（截图显示"失败时重试 3 次"）                  │
│     ├── 分析失败原因（超时？格式错误？）                           │
│     └── 建议：调整 timeout / 优化提示词格式约束                    │
│                                                                 │
│  3. 输出质量分析                                                  │
│     ├── 检查输出是否符合预期结构                                  │
│     ├── 识别常见问题（如角色描述不一致）                           │
│     └── 建议：在提示词中增加约束                                  │
│                                                                 │
│  4. 版本对比总结                                                  │
│     ├── 本次调优改了什么                                         │
│     ├── 效果变化（Token、耗时、质量评分）                          │
│     └── 是否建议采纳本次修改                                      │
│                                                                 │
│  输出格式：                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  📊 运行分析报告 - #56                                    │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │                                                         │    │
│  │  ⏱️ 耗时分析                                             │    │
│  │  • 总耗时: 2小时47分钟                                   │    │
│  │  • 瓶颈节点: "主体素材生成" (2m 2.8s × 30次 = 84分钟)     │    │
│  │  • 建议: 提升并行度从 10 → 15，预计节省 28 分钟           │    │
│  │                                                         │    │
│  │  ❌ 失败分析                                              │    │
│  │  • "主体素材生成" 重试 3 次                               │    │
│  │  • 原因: 即梦 API 限流                                   │    │
│  │  • 建议: 增加请求间隔 或 切换备用绘图引擎                  │    │
│  │                                                         │    │
│  │  📝 提示词优化建议                                        │    │
│  │  • "剧本创作" 输出的场景数较少（8个）                     │    │
│  │  • 建议: 在提示词中强调"每个情节点展开为独立场景"          │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 实施优先级

基于上述影响分析，按**对调优效率的提升程度**排列优先级：

| 优先级 | 功能 | 解决的核心问题 | 预期提升 | 实现复杂度 |
|--------|------|----------------|----------|------------|
| **P0** | **单节点调试** | 不用跑完整流程就能验证提示词 | 迭代时间 3h → 5min | 中 |
| **P0** | **采样运行** | 30个镜头只跑3个验证效果 | 迭代时间 3h → 18min | 低 |
| **P1** | 节点缓存 | 上游节点不重复计算 | 节省 30-50% 时间 | 中 |
| **P1** | 提示词版本对比 | 快速判断哪个版本更好 | 减少无效迭代 | 中 |
| **P2** | AI 优化建议 | 减少盲目试错 | 提高迭代有效性 | 高 |
| **P2** | 增量运行 | 仅重跑变化节点 | 节省 50-70% 时间 | 高 |

### 最小可行方案（MVP）

**目标**：让调优人员从"一天 2 次迭代"提升到"一天 20 次迭代"

```
┌─────────────────────────────────────────────────────────────────┐
│                      MVP 功能清单                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 单节点调试（最重要）                                          │
│     ├── 从历史运行导入输入数据                                    │
│     ├── 单独执行目标节点                                         │
│     └── 查看输出，快速迭代                                        │
│                                                                 │
│  2. 采样运行                                                     │
│     ├── 迭代节点只处理前 N 个                                    │
│     └── 验证通过后再完整运行                                      │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  这两个功能组合的调优流程：                                        │
│                                                                 │
│  改提示词 → 单节点调试（5分钟）→ 确认 OK                          │
│      ↓                                                          │
│  单节点 OK → 采样运行 3 个镜头（18分钟）→ 确认 OK                  │
│      ↓                                                          │
│  采样 OK → 完整运行（3小时，可后台执行）                           │
│                                                                 │
│  ═══════════════════════════════════════════════════════════    │
│  效果：调优验证时间从 3 小时 → 23 分钟（提升 8 倍）                 │
│  ═══════════════════════════════════════════════════════════    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 追踪日志查看困难分析

### 问题现象

从截图可以看到，用户查看节点追踪日志时体验很差。核心问题是 **节点输出数据过于复杂**。

### 具体问题拆解

| 问题 | 具体表现 | 影响 |
|------|----------|------|
| **JSON 嵌套过深** | 输出类似 `"text": "{\"result_assets\": [{\"id\": \"小女孩\"..."`，JSON 序列化成字符串后再嵌入 JSON | 转义字符 `\"` 充斥文本，无法直观阅读 |
| **输出面板空间有限** | 输出面板只占右侧约 1/3 区域 | 大量内容挤在小面板，只能看到开头 |
| **缺少结构化视图** | 只提供原始 JSON 文本 | 没有树形展开、搜索、高亮等功能 |
| **无法快速定位** | 需要在大段 JSON 中人工搜索关键字段 | 调优时找特定角色描述/分镜台词很费劲 |

### 典型输出结构示例

```json
{
  "text": "{\"result_assets\": [{\"id\": \"小女孩\", \"type\": \"human_character\", \"description\": {\"appearance\": \"...\", \"costume\": \"...\", \"expression\": \"...\"}, \"reference_images\": [...]}], \"script\": [{\"segment\": \"场景一\", \"location\": \"...\", \"actions\": [...], \"dialogues\": [...]}]}"
}
```

**问题**：整个结构化输出被序列化成一个字符串，嵌入在 `text` 字段中，可读性极差。

### 优化建议（参考 Coze 实现）

#### 对比分析：Coze vs Dify

| 特性 | Coze ✅ | Dify ❌ |
|------|---------|---------|
| **树形结构** | 显示 `{ 3 Items }`，可折叠展开 | 原始 JSON 文本平铺 |
| **数组索引** | `0:` `1:` 带索引显示 | `[...]` 无索引 |
| **类型着色** | 键名蓝色、字符串绿色、数字橙色 | 无颜色区分 |
| **元信息提示** | `{ 3 Items }` `[ 2 Items ]` | 无 |
| **层级连接线** | 有竖线连接父子节点 | 无 |
| **复制按钮** | 输入/输出分别可复制 | 有 |

#### 细化改进方案

```
┌─────────────────────────────────────────────────────────────────┐
│                    追踪日志查看优化方案                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 树形结构展示（参考 Coze）                                     │
│     ├── 对象显示为 `{ N Items }` 可折叠                          │
│     ├── 数组显示为 `[ N Items ]` 带索引 `0:` `1:`                │
│     ├── 默认展开第一层，深层折叠                                  │
│     └── 点击箭头展开/折叠                                        │
│                                                                 │
│  2. 语法高亮着色                                                  │
│     ├── 键名：蓝色 (#3182ce)                                     │
│     ├── 字符串：绿色 (#38a169)                                   │
│     ├── 数字：橙色 (#dd6b20)                                     │
│     ├── 布尔值：紫色 (#805ad5)                                   │
│     └── null：灰色 (#718096)                                     │
│                                                                 │
│  3. 自动检测并解析嵌套 JSON                                       │
│     ├── 检测 text 字段是否为 JSON 字符串                          │
│     ├── 自动解析并展示为结构化数据                                 │
│     ├── 解析后的内容也支持树形展开                                 │
│     └── 支持一键切换"原始/解析"视图                                │
│                                                                 │
│  4. 字段搜索与导航                                                │
│     ├── 搜索框支持字段名/值搜索                                   │
│     ├── 匹配结果高亮 + 自动展开路径                               │
│     ├── 上/下箭头切换匹配项                                       │
│     └── 显示匹配数量 "3/10"                                      │
│                                                                 │
│  5. 长文本智能截断                                                │
│     ├── 超过 100 字符的字符串截断显示                             │
│     ├── 显示 "..." 和 [展开] 按钮                                │
│     └── 点击展开显示完整内容                                      │
│                                                                 │
│  6. 快捷操作                                                      │
│     ├── 单个字段复制按钮（hover 显示）                            │
│     ├── 整体输入/输出复制（顶部按钮）                              │
│     ├── 导出为 JSON 文件                                         │
│     └── 在新窗口打开（大数据量时）                                 │
│                                                                 │
│  7. 面板增强                                                      │
│     ├── 支持拖拽调整面板宽度                                      │
│     ├── 支持全屏/半屏切换                                        │
│     └── 固定顶部标题栏，内容区域滚动                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 树形展示效果示例

```
输出 📋                                           [展开全部] [折叠全部]
──────────────────────────────────────────────────────────────────────
▼ { 2 Items }
  │
  ├─ "text": { 1 Items }  ⚠️ 已解析嵌套JSON
  │    │
  │    └─ ▼ "result_assets": [ 3 Items ]
  │         │
  │         ├─ 0: { 4 Items }
  │         │    ├─ "id": "小女孩"
  │         │    ├─ "type": "human_character"
  │         │    ├─ ▶ "description": { 3 Items }    ← 点击展开
  │         │    └─ ▶ "reference_images": [ 2 Items ]
  │         │
  │         ├─ 1: { 4 Items }
  │         │    └─ ...
  │         │
  │         └─ 2: { 4 Items }
  │              └─ ...
  │
  └─ "usage": { 2 Items }
       ├─ "total_tokens": 9777
       └─ "completion_tokens": 8234
```

#### 技术实现建议

| 组件 | 推荐方案 | 说明 |
|------|----------|------|
| **树形组件** | react-json-view 或 自研 | 支持折叠、搜索、复制 |
| **语法高亮** | 自定义 CSS 变量 | 与 Dify 主题一致 |
| **嵌套解析** | 递归检测 + 按需解析 | 避免性能问题 |
| **虚拟滚动** | react-window | 大数据量时保证性能 |
| **搜索** | 前端全文搜索 + 路径展开 | 实时高亮 |

---

### 深层问题：子工作流（工作流工具）输出冗余

#### 问题现象

分析实际的子工作流输出数据，发现同一份数据重复了 **4 次**：

```
子工作流输出结构：
├── text: "{"result_assets": [...]}"        ← 第1次：JSON 字符串（难读）
├── files: [...]                            ← 文件引用
├── json: [{ result_assets: [...] }]        ← 第2次：结构化数据
├── art_style_ref_file: [...]               ← 第3次：提取的文件数组
└── result_assets: [...]                    ← 第4次：提取的业务数据
```

#### 冗余量化

| 字段 | 大小估算 | 说明 |
|------|----------|------|
| `text` | ~8KB | JSON 字符串，与 json/result_assets 内容完全重复 |
| `json` | ~8KB | 结构化数据，与 result_assets 完全重复 |
| `result_assets` | ~8KB | **主数据** |
| `art_style_ref_file` | ~0.5KB | 与 json 内的同名字段重复 |
| `files` | ~0.5KB | 与 art_style_ref_file 重复 |

**实际有效数据 ~8KB，展示了 ~25KB，冗余率超过 200%**

#### 根本原因

这是 **Dify 工作流工具（子工作流调用）的输出机制** 导致的：

```
┌─────────────────────────────────────────────────────────────────┐
│                    工作流工具输出机制                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  子工作流「结束节点」定义的输出变量：                              │
│  ├── result_assets: Array<Asset>                                │
│  └── art_style_ref_file: Array<File>                            │
│                                                                 │
│  调用子工作流后，Dify 自动生成的输出字段：                         │
│  ├── text       → 所有输出序列化成 JSON 字符串（兼容纯文本场景）   │
│  ├── json       → 所有输出的结构化版本（数组包裹）                 │
│  ├── files      → 自动提取所有 File 类型变量                      │
│  └── {变量名}   → 每个输出变量提升到顶层                          │
│                                                                 │
│  问题：设计意图是灵活，但实际导致数据重复 3-4 次                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 对调试体验的影响

| 影响 | 说明 |
|------|------|
| **视觉噪音** | 用户要在重复数据中找到真正需要的字段 |
| **滚动疲劳** | 同样内容滚动 4 遍才能看完 |
| **理解成本** | 用户困惑：text/json/result_assets 有什么区别？该看哪个？ |
| **调试效率** | 查找特定字段时，不知道该在哪个副本中找 |

#### 优化方案

**方案 A：UI 层智能去重（推荐，不改后端）**

```
┌─────────────────────────────────────────────────────────────────┐
│  输出                                              📋 [原始视图] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 📦 业务数据 ──────────────────────────────────────────────┐ │
│  │                                                            │ │
│  │  ▼ result_assets [ 4 Items ]                               │ │
│  │    ├─ 0: { id: "小青蛙", type: "creature_character" }      │ │
│  │    ├─ 1: { id: "大海龟", type: "creature_character" }      │ │
│  │    ├─ 2: { id: "古井底部", type: "scene" }                 │ │
│  │    └─ 3: { id: "幻想中的大海", type: "scene" }             │ │
│  │                                                            │ │
│  │  ▼ art_style_ref_file [ 1 Items ]                          │ │
│  │    └─ 0: { filename: "800451...jpg" } 🖼️ [预览]            │ │
│  │                                                            │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 🔧 系统字段 (已折叠，与上方重复) ──────────────────────────┐ │
│  │  text, json, files - 点击展开查看原始数据                   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**智能去重逻辑**：

```python
def dedupe_workflow_tool_output(output: dict) -> dict:
    """去重工作流工具输出，返回展示优先级"""

    # 1. 识别工作流工具输出特征
    is_workflow_tool = all(k in output for k in ["text", "json", "files"])

    if not is_workflow_tool:
        return {"primary": output, "secondary": {}}

    # 2. 提取业务数据（排除系统字段）
    system_fields = {"text", "json", "files"}
    business_fields = {k: v for k, v in output.items() if k not in system_fields}

    # 3. 返回分层结构
    return {
        "primary": business_fields,      # 默认展示：业务数据
        "secondary": {                   # 折叠展示：系统字段
            "text": output.get("text"),
            "json": output.get("json"),
            "files": output.get("files")
        },
        "is_workflow_tool": True
    }
```

**方案 B：后端优化输出结构（需改 Dify 核心）**

```python
# 工作流工具输出时，添加 _meta 字段标记冗余关系
{
    "_meta": {
        "output_type": "workflow_tool",
        "primary_fields": ["result_assets", "art_style_ref_file"],
        "derived_fields": {
            "text": "serialized from primary_fields",
            "json": "wrapped primary_fields",
            "files": "extracted from primary_fields"
        }
    },
    "result_assets": [...],
    "art_style_ref_file": [...],
    "text": "...",  # 可选：设置 display: false
    "json": [...],
    "files": [...]
}
```

#### 针对 AIGC 工作流的特殊优化

AIGC 工作流输出通常包含 **大量图片 URL**，建议：

| 优化 | 说明 |
|------|------|
| **图片预览** | 识别 `url` 字段，显示缩略图而非长 URL |
| **URL 截断** | `https://...sign=abc...` → `https://.../xxx.jpg` [复制] |
| **文件列表视图** | `ref_file` 对象显示为 `📷 xxx.jpg (500KB)` 而非完整 JSON |
| **Asset 卡片视图** | `result_assets` 显示为卡片列表，每个卡片含缩略图 + 名称 |

**Asset 卡片视图示例**：

```
┌─────────────────────────────────────────────────────────────────┐
│  result_assets [ 4 Items ]                        [列表] [卡片] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  🖼️ [缩略图] │  │  🖼️ [缩略图] │  │  🖼️ [缩略图] │          │
│  │              │  │              │  │              │          │
│  │  小青蛙       │  │  大海龟       │  │  古井底部     │          │
│  │  creature    │  │  creature    │  │  scene       │          │
│  │  [查看详情]   │  │  [查看详情]   │  │  [查看详情]   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据分层架构：Dify + Langfuse

### 背景

系统已接入 Langfuse 进行全链路追踪，需要明确 Dify UI 与 Langfuse 的职责边界，避免功能重复。

### 三层数据架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据查看分层架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 业务视图 (Dify)                                       │   │
│  │  ═══════════════════════════                                    │   │
│  │  用户: 业务专家、提示词工程师                                    │   │
│  │  内容: 提示词、输出内容(Markdown渲染)、图片预览                  │   │
│  │  场景: 日常调优、验证输出质量                                    │   │
│  │  特点: 简洁、可读、去技术化                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Layer 2: 开发视图 (Dify)                                       │   │
│  │  ═══════════════════════════                                    │   │
│  │  用户: 开发人员                                                  │   │
│  │  内容: 单节点完整输入/输出 JSON、变量值                          │   │
│  │  场景: 排查单节点问题、验证数据格式                              │   │
│  │  特点: 完整、可搜索、可复制                                      │   │
│  │  边界: 仅当前节点数据，不做跨节点分析                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Layer 3: 全链路追踪 (Langfuse)                                 │   │
│  │  ═══════════════════════════════                                │   │
│  │  用户: 开发人员、运维、技术负责人                                │   │
│  │  内容: 全链路 trace、性能分析、成本归因、历史对比                │   │
│  │  场景: 性能优化、成本分析、跨节点问题排查、A/B 评估              │   │
│  │  特点: 全局视角、可追溯、可对比                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 职责边界明确

| 能力 | Dify 业务视图 | Dify 开发视图 | Langfuse |
|------|---------------|---------------|----------|
| 查看提示词 | ✅ 主要 | ✅ 完整 | ✅ 有 |
| 查看输出内容 | ✅ Markdown 渲染 | ✅ JSON 原始 | ✅ 有 |
| 图片预览 | ✅ 主要 | ✅ 有 | ❌ 无 |
| 单节点 JSON | ❌ 隐藏 | ✅ 主要 | ✅ 有 |
| Token 统计 | ❌ 隐藏 | ⚪ 可选显示 | ✅ 主要 |
| 费用分析 | ❌ 隐藏 | ⚪ 可选显示 | ✅ 主要 |
| 耗时分析 | ⚪ 简单显示 | ⚪ 节点级 | ✅ 全链路 |
| 跨节点数据流 | ❌ 无 | ❌ 无 | ✅ 主要 |
| 历史对比 | ❌ 无 | ❌ 无 | ✅ 主要 |
| 错误追踪 | ⚪ 显示失败 | ⚪ 显示错误信息 | ✅ 堆栈+上下文 |

### 关键决策：Dify 开发视图要不要做？

**结论：要做，但要克制**

**理由**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     为什么 Dify 开发视图仍然需要？                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 上下文连续性                                                         │
│     ├── 用户在 Dify 中调试，发现问题想看详情                             │
│     ├── 如果必须跳转 Langfuse，上下文断裂                                │
│     └── 简单问题应该在 Dify 内闭环解决                                   │
│                                                                         │
│  2. 使用频率差异                                                         │
│     ├── 业务专家：90% 时间在 Dify 业务视图                               │
│     ├── 开发人员：日常调试也在 Dify，复杂问题才去 Langfuse               │
│     └── Langfuse 是"深度分析工具"，不是"日常工具"                        │
│                                                                         │
│  3. 权限隔离                                                             │
│     ├── 业务专家可能没有 Langfuse 访问权限                               │
│     ├── Dify 开发视图作为中间层                                          │
│     └── 需要更详细数据时，开发介入并使用 Langfuse                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**但要克制，不要在 Dify 中重复 Langfuse 的能力**：

| 不要做 | 原因 |
|--------|------|
| 全链路 trace 可视化 | Langfuse 的核心能力 |
| 跨节点数据流分析 | Langfuse 更专业 |
| 历史运行对比 | Langfuse 有完整数据 |
| 成本归因分析 | Langfuse 的强项 |
| 性能瓶颈定位 | Langfuse 的 span 分析更专业 |

### 用户动线设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户动线设计                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  业务专家日常调优:                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Dify 业务视图                                                    │  │
│  │       │                                                          │  │
│  │       ├── 查看输出 → 不满意 → 修改提示词 → 重新运行               │  │
│  │       │                                                          │  │
│  │       └── 输出格式异常 → 切换到开发视图 → 看 JSON 结构            │  │
│  │                              │                                    │  │
│  │                              └── 还是不懂 → 找开发帮忙            │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  开发排查问题:                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Dify 开发视图                                                    │  │
│  │       │                                                          │  │
│  │       ├── 单节点问题 → 查看输入输出 → 定位问题 → 修复             │  │
│  │       │                                                          │  │
│  │       └── 跨节点问题 / 性能问题 / 成本分析                        │  │
│  │                   │                                               │  │
│  │                   ▼                                               │  │
│  │           [在 Langfuse 中查看] ← 提供跳转链接                     │  │
│  │                   │                                               │  │
│  │                   ▼                                               │  │
│  │             Langfuse 全链路分析                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Dify 中集成 Langfuse 跳转

在 Dify 开发视图中，提供一键跳转到 Langfuse 的入口：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              ✕    │
│  耗时: 2m 2.810s                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 快捷操作 ────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  [📊 在 Langfuse 中查看]  [📋 复制 Trace ID]                       │ │
│  │                                                                    │ │
│  │  Trace ID: abc123-def456-...                                       │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ...（开发视图内容）                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 总结：分层原则

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           分层原则                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Dify 业务视图:                                                          │
│  └── "让业务专家看懂，能自主调优"                                        │
│                                                                         │
│  Dify 开发视图:                                                          │
│  └── "让开发快速定位单节点问题，简单问题不用跳出 Dify"                   │
│                                                                         │
│  Langfuse:                                                               │
│  └── "全局视角、深度分析、历史追溯"                                      │
│                                                                         │
│  ═══════════════════════════════════════════════════════════════════   │
│                                                                         │
│  不要在 Dify 中重复造 Langfuse                                           │
│  但要保证 Dify 内能解决 80% 的日常问题                                   │
│  复杂问题提供顺畅的 Langfuse 跳转                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 用户角色分析

| 维度 | 业务专家 | 开发人员 |
|------|----------|----------|
| **关心什么** | 提示词是什么？输出内容对不对？ | 完整数据结构、调用链、性能指标 |
| **痛点** | 被技术字段淹没，找不到关键信息 | 需要原始数据排查问题 |
| **调优目标** | 优化提示词措辞、调整业务参数 | 排查节点错误、性能瓶颈 |
| **技术背景** | 不了解 JSON、API 概念 | 熟悉数据结构和调试工具 |
| **使用频率** | 高频（每天调优） | 低频（出问题时介入） |

### 视图切换设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              ✕    │
│  耗时: 2m 2.810s                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
│             ~~~~~~~~~~~~                                                │
│             (默认)                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 业务视图（默认）

**设计原则**：只展示业务人员关心的内容，隐藏所有技术细节

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              ✕    │
│  耗时: 2m 2.810s                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 📥 输入 ─────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  故事内容:                                                         │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  从前有一只小青蛙，住在井底，它以为天空只有井口那么大...       │ │ │
│  │  │                                                              │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                                    │ │
│  │  美术风格: 国风手绘风，Q版古风风格                                  │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 📤 生成的素材 ───────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  角色 (2个)                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────┐   │ │
│  │  │  ┌─────────┐                                               │   │ │
│  │  │  │ 🖼️      │  小青蛙                                       │   │ │
│  │  │  │         │  一只生活在井底的Q版小青蛙，身体翠绿，         │   │ │
│  │  │  │         │  肚子圆滚滚，头顶一片小荷叶。                  │   │ │
│  │  │  └─────────┘                                               │   │ │
│  │  └────────────────────────────────────────────────────────────┘   │ │
│  │  ┌────────────────────────────────────────────────────────────┐   │ │
│  │  │  ┌─────────┐                                               │   │ │
│  │  │  │ 🖼️      │  大海龟                                       │   │ │
│  │  │  │         │  一只体型巨大、性格温和的Q版大海龟，           │   │ │
│  │  │  │         │  身体呈奶油黄色，脸上总是带着微笑。            │   │ │
│  │  │  └─────────┘                                               │   │ │
│  │  └────────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  │  场景 (2个)                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────┐   │ │
│  │  │  ┌─────────┐                                               │   │ │
│  │  │  │ 🖼️      │  古井底部                                     │   │ │
│  │  │  │         │  一个幽深、长满苔藓的圆形古井底部，            │   │ │
│  │  │  │         │  水面清澈，能看到上方圆形的天空。              │   │ │
│  │  │  └─────────┘                                               │   │ │
│  │  └────────────────────────────────────────────────────────────┘   │ │
│  │  ┌────────────────────────────────────────────────────────────┐   │ │
│  │  │  ┌─────────┐                                               │   │ │
│  │  │  │ 🖼️      │  幻想中的大海                                 │   │ │
│  │  │  │         │  一个Q版幻想风格的无边大海场景，               │   │ │
│  │  │  │         │  海面广阔，海天一色。                          │   │ │
│  │  │  └─────────┘                                               │   │ │
│  │  └────────────────────────────────────────────────────────────┘   │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 🎨 风格参考图 ───────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  ┌───────────────┐                                                │ │
│  │  │               │                                                │ │
│  │  │   🖼️ 预览图    │  点击查看大图                                  │ │
│  │  │               │                                                │ │
│  │  └───────────────┘                                                │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**业务视图隐藏的内容**：

| 隐藏字段 | 原因 |
|----------|------|
| `text` | JSON 字符串，业务人员看不懂 |
| `json` | 与业务数据重复 |
| `files` | 与风格参考图重复 |
| `ref_file` 对象内部 | `tenant_id`、`dify_model_identity` 等无意义 |
| `details` 对象 | `body_structure`、`surface_texture` 等技术细节 |
| `visual_profile` | 给生图模型的提示词，业务人员不需要 |

### 开发视图

**设计原则**：完整展示所有数据，支持深度调试

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              ✕    │
│  耗时: 2m 2.810s  |  Tokens: 133.1K  |  费用: ¥2.36                     │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
│                           ~~~~~~~~~~~~                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🔍 搜索字段...                            [展开全部] [折叠全部] [复制]  │
│                                                                         │
│  ┌─ 输入 ────────────────────────────────────────────────────────────┐ │
│  │  ▼ { 5 Items }                                                    │ │
│  │    "input": "从前有一只小青蛙...",                                │ │
│  │    "art_style": "国风手绘风，Q版古风风格",                         │ │
│  │    "lesson_name": "井底之蛙",                                     │ │
│  │    ▶ "art_style_ref": { ... }                                     │ │
│  │    ▶ "config": { ... }                                            │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 输出 ────────────────────────────────────────────────────────────┐ │
│  │  ▼ { 5 Items }                                                    │ │
│  │    ▶ "text": "{"result_assets": [{..."  ⚠️ JSON字符串             │ │
│  │    ▶ "files": [ 1 Items ]                                         │ │
│  │    ▶ "json": [ 1 Items ]                                          │ │
│  │    ▼ "result_assets": [ 4 Items ]                                 │ │
│  │      ├─ 0: ▼ { 8 Items }                                          │ │
│  │      │     "id": "小青蛙",                                        │ │
│  │      │     "type": "creature_character",                          │ │
│  │      │     "ref_image": null,                                     │ │
│  │      │     "description": "一只生活在井底的Q版小青蛙...",          │ │
│  │      │     ▶ "details": { 7 Items }                               │ │
│  │      │     "visual_profile": "国风手绘风，Q版古风风格...",         │ │
│  │      │     ▶ "ref_file": { 12 Items }                             │ │
│  │      │     "ref_url": "https://ai-hub-api..."                     │ │
│  │      ├─ 1: ▶ { 8 Items } "大海龟"                                 │ │
│  │      ├─ 2: ▶ { 8 Items } "古井底部"                               │ │
│  │      └─ 3: ▶ { 8 Items } "幻想中的大海"                           │ │
│  │    ▶ "art_style_ref_file": [ 1 Items ]                            │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 元数据 ──────────────────────────────────────────────────────────┐ │
│  │  节点ID: node_abc123                                              │ │
│  │  执行时间: 2024-01-15 14:40:54                                    │ │
│  │  重试次数: 0                                                      │ │
│  │  [查看原始 JSON] [导出数据]                                       │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 对比总结

| 特性 | 业务视图 | 开发视图 |
|------|----------|----------|
| **输入展示** | 只显示业务参数（故事内容、美术风格） | 完整 JSON 树 |
| **输出展示** | 按类型分组的卡片（角色、场景） | 完整 JSON 树 + 折叠控制 |
| **图片** | 直接预览 | URL + 预览 |
| **技术字段** | 完全隐藏 | 全部展示 |
| **Token/费用** | 隐藏 | 显示 |
| **搜索/复制** | 无 | 有 |
| **数据导出** | 无 | 支持 JSON 导出 |

### 字段映射规则

业务视图需要将技术字段映射为业务语言：

```typescript
const businessFieldMapping = {
  // 输入字段映射
  input: {
    'input': { label: '故事内容', display: 'textarea' },
    'art_style': { label: '美术风格', display: 'text' },
    'lesson_name': { label: '课程名称', display: 'text' },
    'art_style_ref': { label: '风格参考图', display: 'image' },
    // 隐藏的字段
    'config': { hidden: true },
  },

  // 输出字段映射
  output: {
    'result_assets': {
      label: '生成的素材',
      display: 'asset_cards',
      groupBy: 'type',  // 按类型分组
      groupLabels: {
        'human_character': '人物角色',
        'creature_character': '角色',
        'scene': '场景',
        'prop': '道具'
      },
      // 每个 asset 只显示这些字段
      visibleFields: ['id', 'description', 'ref_url'],
    },
    'art_style_ref_file': {
      label: '风格参考图',
      display: 'image_gallery'
    },
    // 隐藏的字段
    'text': { hidden: true },
    'json': { hidden: true },
    'files': { hidden: true },
  }
};
```

### 针对 LLM 节点的业务视图

对于 LLM 节点（如"剧本创作"），业务视图更加简化：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  剧本创作 ✅ 成功                                                  ✕    │
│  耗时: 45s                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 📥 输入 ─────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  提示词:                                                           │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  你是一位专业的儿童故事编剧。请根据以下故事内容，创作一个     │ │ │
│  │  │  适合3-6岁儿童观看的动画剧本...                              │ │ │
│  │  │                                                              │ │ │
│  │  │  【故事内容】                                                 │ │ │
│  │  │  {{input}}                                                   │ │ │
│  │  │                                                              │ │ │
│  │  │  【输出要求】                                                 │ │ │
│  │  │  1. 分镜数量：15-25个                                        │ │ │
│  │  │  2. 每个分镜包含：场景、动作、台词...                         │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                           [复制] │ │
│  │                                                                    │ │
│  │  故事内容: 从前有一只小青蛙，住在井底...                           │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 📤 输出 ─────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  生成的剧本:                                                       │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  【场景一：井底】                                             │ │ │
│  │  │  小青蛙坐在井底的石头上，仰望着头顶那一小片圆圆的天空。       │ │ │
│  │  │                                                              │ │ │
│  │  │  小青蛙：（得意地）哈哈，天就这么大，我可是见过整个世界的     │ │ │
│  │  │  青蛙！                                                       │ │ │
│  │  │                                                              │ │ │
│  │  │  【场景二：井边】                                             │ │ │
│  │  │  大海龟路过井边，往下看了看...                                │ │ │
│  │  │                                                              │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                           [复制] │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**LLM 节点业务视图只显示**：
- 提示词（System Prompt + User Message）
- 变量值（如 `{{input}}` 的实际内容）
- 模型输出（纯文本或解析后的结构化内容）

**隐藏**：
- `usage`（Token 消耗、费用）
- `finish_reason`
- `reasoning_content`
- 模型配置参数

### 视图偏好设置

用户可以设置默认视图，系统记住偏好：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ⚙️ 调试偏好设置                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  默认视图模式:                                                          │
│  ○ 📝 业务视图 - 简化显示，适合提示词调优                                │
│  ● 🔧 开发视图 - 完整数据，适合技术排查                                  │
│                                                                         │
│  业务视图显示选项:                                                       │
│  ☑ 显示耗时                                                             │
│  ☐ 显示 Token 消耗                                                      │
│  ☐ 显示费用                                                             │
│  ☑ 显示图片预览                                                         │
│                                                                         │
│                                              [恢复默认] [保存]           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 文本内容智能渲染

#### 问题背景

LLM 输出的 `text` 字段可能是多种格式：

| 格式 | 示例 | 最佳渲染方式 |
|------|------|--------------|
| **Markdown** | `## 场景一\n**小青蛙**坐在井底...` | Markdown 富文本 |
| **纯文本** | `【场景一】小青蛙坐在井底...` | 保留换行的文本 |
| **JSON 字符串** | `{"result_assets": [...]}` | 结构化卡片/JSON 树 |
| **代码** | ` ```python\nprint("hello")``` ` | 代码高亮 |

**当前问题**：Dify 统一用原始文本/JSON 展示，Markdown 格式的内容无法正确渲染。

#### 智能渲染策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        文本内容智能渲染流程                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: text 字段内容                                                     │
│    │                                                                    │
│    ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 1: 检测内容类型                                            │   │
│  │  ├── 尝试 JSON.parse() → 成功 → JSON 类型                        │   │
│  │  ├── 检测 Markdown 特征 → 命中 → Markdown 类型                   │   │
│  │  └── 否则 → 纯文本类型                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│    │                                                                    │
│    ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 2: 选择渲染组件                                            │   │
│  │  ├── JSON 类型 → 检查是否有 structured_output                    │   │
│  │  │              ├── 有 → 渲染 structured_output（卡片/表格）     │   │
│  │  │              └── 无 → JSON 树组件                             │   │
│  │  ├── Markdown 类型 → Markdown 渲染组件                           │   │
│  │  └── 纯文本类型 → 保留格式的文本组件（white-space: pre-wrap）    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│    │                                                                    │
│    ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Step 3: 提供格式切换                                            │   │
│  │  └── 右上角显示 [Markdown] [纯文本] [JSON] 切换按钮              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Markdown 特征检测

```typescript
function detectContentType(text: string): 'markdown' | 'json' | 'plain' {
  // 1. 尝试 JSON 解析
  try {
    JSON.parse(text);
    return 'json';
  } catch {}

  // 2. 检测 Markdown 特征
  const markdownPatterns = [
    /^#{1,6}\s+/m,           // 标题: # ## ###
    /\*\*[^*]+\*\*/,         // 加粗: **text**
    /\*[^*]+\*/,             // 斜体: *text*
    /^\s*[-*+]\s+/m,         // 无序列表: - item
    /^\s*\d+\.\s+/m,         // 有序列表: 1. item
    /\[.+\]\(.+\)/,          // 链接: [text](url)
    /```[\s\S]*?```/,        // 代码块: ```code```
    /`[^`]+`/,               // 行内代码: `code`
    /^\s*>\s+/m,             // 引用: > quote
    /\|.+\|.+\|/,            // 表格: | col | col |
  ];

  const matchCount = markdownPatterns.filter(p => p.test(text)).length;

  // 命中 2 个以上特征，判定为 Markdown
  if (matchCount >= 2) {
    return 'markdown';
  }

  return 'plain';
}
```

#### 业务视图中的渲染效果对比

**场景：剧本创作节点输出**

原始内容：
```markdown
## 场景一：井底

**小青蛙**坐在井底的石头上，仰望着头顶那一小片圆圆的天空。

> 小青蛙：（得意地）哈哈，天就这么大，我可是见过整个世界的青蛙！

### 动作描述
- 小青蛙跳上石头
- 抬头仰望
- 双手叉腰，一脸骄傲

## 场景二：井边

**大海龟**路过井边，好奇地往下看了看。
```

**当前 Dify 展示（原始文本）**：
```
┌────────────────────────────────────────────────────────────────────────┐
│  输出:                                                                 │
│  ## 场景一：井底                                                        │
│                                                                        │
│  **小青蛙**坐在井底的石头上，仰望着头顶那一小片圆圆的天空。              │
│                                                                        │
│  > 小青蛙：（得意地）哈哈，天就这么大，我可是见过整个世界的青蛙！        │
│                                                                        │
│  ### 动作描述                                                          │
│  - 小青蛙跳上石头                                                      │
│  - 抬头仰望                                                            │
│  ...                                                                   │
└────────────────────────────────────────────────────────────────────────┘
```

**优化后（Markdown 渲染）**：
```
┌────────────────────────────────────────────────────────────────────────┐
│  输出:                                          [Markdown ▼] [复制]    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │
│  ┃                                                                  ┃ │
│  ┃  场景一：井底                                                    ┃ │
│  ┃  ═══════════════                                                 ┃ │
│  ┃                                                                  ┃ │
│  ┃  𝗦𝗺𝗮𝗹𝗹 𝗙𝗿𝗼𝗴 坐在井底的石头上，仰望着头顶那一小片圆圆的天空。        ┃ │
│  ┃                                                                  ┃ │
│  ┃  ┃ 小青蛙：（得意地）哈哈，天就这么大，                          ┃ │
│  ┃  ┃ 我可是见过整个世界的青蛙！                                    ┃ │
│  ┃                                                                  ┃ │
│  ┃  动作描述                                                        ┃ │
│  ┃  ───────────                                                     ┃ │
│  ┃  • 小青蛙跳上石头                                                ┃ │
│  ┃  • 抬头仰望                                                      ┃ │
│  ┃  • 双手叉腰，一脸骄傲                                            ┃ │
│  ┃                                                                  ┃ │
│  ┃                                                                  ┃ │
│  ┃  场景二：井边                                                    ┃ │
│  ┃  ═══════════════                                                 ┃ │
│  ┃                                                                  ┃ │
│  ┃  𝗕𝗶𝗴 𝗧𝘂𝗿𝘁𝗹𝗲 路过井边，好奇地往下看了看。                           ┃ │
│  ┃                                                                  ┃ │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛ │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

#### 格式切换下拉菜单

```
┌────────────────────────────────────────────────────────────────────────┐
│  输出:                                          [Markdown ▼] [复制]    │
│                                                 ┌──────────────┐       │
│                                                 │ ✓ Markdown   │       │
│                                                 │   纯文本     │       │
│                                                 │   JSON       │       │
│                                                 └──────────────┘       │
└────────────────────────────────────────────────────────────────────────┘
```

#### 不同节点类型的默认渲染策略

| 节点类型 | text 内容特征 | 业务视图默认渲染 |
|----------|---------------|------------------|
| **LLM 节点** | Markdown/纯文本剧本 | Markdown 渲染 |
| **代码节点** | 代码执行结果 | 代码高亮 |
| **工作流工具** | JSON 字符串 | 优先显示 structured_output/业务字段 |
| **HTTP 请求** | JSON 响应 | JSON 树 |
| **模板转换** | 模板渲染结果 | Markdown 渲染 |

#### 完整的业务视图 - LLM 节点示例

```
┌─────────────────────────────────────────────────────────────────────────┐
│  剧本创作 ✅ 成功                                                  ✕    │
│  耗时: 45s                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│  视图模式:  [📝 业务视图]  [🔧 开发视图]                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─ 📥 输入提示词 ───────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  系统提示词:                                 [展开全文] [复制]     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  你是一位专业的儿童故事编剧。请根据以下故事内容，创作一个     │ │ │
│  │  │  适合3-6岁儿童观看的动画剧本。                               │ │ │
│  │  │                                                              │ │ │
│  │  │  ## 输出要求                                                 │ │ │
│  │  │  1. 分镜数量：15-25个                                        │ │ │
│  │  │  2. 每个分镜包含：场景、动作、台词                           │ │ │
│  │  │  ...                                                         │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                                    │ │
│  │  用户输入:                                                         │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  从前有一只小青蛙，住在井底，它以为天空只有井口那么大。       │ │ │
│  │  │  有一天，一只大海龟路过，告诉它外面有广阔的大海...           │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌─ 📤 模型输出 ────────────────────────────────── [Markdown ▼] [复制] │
│  │                                                                    │ │
│  │  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  场景一：井底                                                ┃ │ │
│  │  ┃  ═══════════════                                             ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  小青蛙 坐在井底的石头上，仰望着头顶那一小片圆圆的天空。      ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  ┃ 小青蛙：（得意地）哈哈，天就这么大，                      ┃ │ │
│  │  ┃  ┃ 我可是见过整个世界的青蛙！                                ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  动作描述                                                    ┃ │ │
│  │  ┃  ───────────                                                 ┃ │ │
│  │  ┃  • 小青蛙跳上石头                                            ┃ │ │
│  │  ┃  • 抬头仰望                                                  ┃ │ │
│  │  ┃  • 双手叉腰，一脸骄傲                                        ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  场景二：井边                                                ┃ │ │
│  │  ┃  ═══════════════                                             ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  大海龟 路过井边，好奇地往下看了看。                          ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┃  ...                                                         ┃ │ │
│  │  ┃                                                              ┃ │ │
│  │  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛ │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 技术实现

```typescript
// 输出渲染组件
interface OutputRendererProps {
  content: string;
  defaultFormat?: 'auto' | 'markdown' | 'plain' | 'json';
  allowFormatSwitch?: boolean;
}

function OutputRenderer({ content, defaultFormat = 'auto', allowFormatSwitch = true }: OutputRendererProps) {
  const detectedFormat = defaultFormat === 'auto'
    ? detectContentType(content)
    : defaultFormat;

  const [format, setFormat] = useState(detectedFormat);

  return (
    <div className="output-renderer">
      {allowFormatSwitch && (
        <FormatSwitcher
          current={format}
          detected={detectedFormat}
          onChange={setFormat}
        />
      )}

      {format === 'markdown' && (
        <MarkdownRenderer content={content} />
      )}

      {format === 'plain' && (
        <pre className="whitespace-pre-wrap">{content}</pre>
      )}

      {format === 'json' && (
        <JsonTreeView data={JSON.parse(content)} />
      )}
    </div>
  );
}

// Markdown 渲染组件（使用 react-markdown）
function MarkdownRenderer({ content }: { content: string }) {
  return (
    <div className="markdown-body prose prose-sm max-w-none">
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}  // 支持 GFM（表格、任务列表等）
        components={{
          // 自定义代码块渲染
          code: ({ node, inline, className, children, ...props }) => {
            if (inline) {
              return <code className="bg-gray-100 px-1 rounded">{children}</code>;
            }
            return (
              <SyntaxHighlighter language={getLanguage(className)}>
                {String(children)}
              </SyntaxHighlighter>
            );
          },
          // 自定义引用块样式（用于台词）
          blockquote: ({ children }) => (
            <blockquote className="border-l-4 border-blue-400 pl-4 italic bg-blue-50 py-2">
              {children}
            </blockquote>
          ),
        }}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
}
```

### 设计目标

1. **去重**：识别工作流工具输出，自动折叠重复字段
2. **分层**：业务数据优先展示，系统字段折叠
3. **可视化**：图片预览、Asset 卡片、URL 简化
4. **可操作**：搜索、复制、展开/折叠

### 完整 UI 原型

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主体素材生成 ✅ 成功                                              ✕    │
│  耗时: 2m 2.810s  |  Tokens: 133.1K                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  [结果] [详情] [追踪]                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  🔍 搜索字段...                            [展开全部] [折叠全部] [复制]  │
│                                                                         │
│  ═══════════════════════════════════════════════════════════════════   │
│  📦 业务输出                                                            │
│  ═══════════════════════════════════════════════════════════════════   │
│                                                                         │
│  ┌─ result_assets ──────────────────────────────── [ 4 Items ] ──┐     │
│  │                                                                │     │
│  │  视图切换: [📋 列表]  [🎴 卡片]  [📝 JSON]                      │     │
│  │                                                                │     │
│  │  ┌────────────────────────────────────────────────────────┐   │     │
│  │  │  ┌─────────┐                                           │   │     │
│  │  │  │ 🖼️      │  小青蛙                                   │   │     │
│  │  │  │ [预览图] │  creature_character                       │   │     │
│  │  │  │         │  ─────────────────────────────────────    │   │     │
│  │  │  └─────────┘  一只生活在井底的Q版小青蛙，身体翠绿，     │   │     │
│  │  │               肚子圆滚滚，头顶一片小荷叶。               │   │     │
│  │  │                                                        │   │     │
│  │  │               ▶ details { 7 Items }                    │   │     │
│  │  │               ▶ visual_profile "国风手绘风，Q版古..."   │   │     │
│  │  │                                            [📋 复制]   │   │     │
│  │  └────────────────────────────────────────────────────────┘   │     │
│  │                                                                │     │
│  │  ┌────────────────────────────────────────────────────────┐   │     │
│  │  │  ┌─────────┐                                           │   │     │
│  │  │  │ 🖼️      │  大海龟                                   │   │     │
│  │  │  │ [预览图] │  creature_character                       │   │     │
│  │  │  │         │  ─────────────────────────────────────    │   │     │
│  │  │  └─────────┘  一只体型巨大、性格温和的Q版大海龟...       │   │     │
│  │  │               ▶ details { 7 Items }                    │   │     │
│  │  └────────────────────────────────────────────────────────┘   │     │
│  │                                                                │     │
│  │  ┌────────────────────────────────────────────────────────┐   │     │
│  │  │  ┌─────────┐                                           │   │     │
│  │  │  │ 🖼️      │  古井底部                                 │   │     │
│  │  │  │ [预览图] │  scene                                    │   │     │
│  │  │  │         │  ─────────────────────────────────────    │   │     │
│  │  │  └─────────┘  一个幽深、长满苔藓的圆形古井底部...        │   │     │
│  │  └────────────────────────────────────────────────────────┘   │     │
│  │                                                                │     │
│  │  ┌────────────────────────────────────────────────────────┐   │     │
│  │  │  ┌─────────┐                                           │   │     │
│  │  │  │ 🖼️      │  幻想中的大海                             │   │     │
│  │  │  │ [预览图] │  scene                                    │   │     │
│  │  │  └─────────┘  一个Q版幻想风格的无边大海场景...           │   │     │
│  │  └────────────────────────────────────────────────────────┘   │     │
│  │                                                                │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                                                                         │
│  ┌─ art_style_ref_file ─────────────────────────── [ 1 Items ] ──┐     │
│  │                                                                │     │
│  │  ┌─────────┐  80045219c926435295fe06f8edad194f.jpg             │     │
│  │  │ 🖼️      │  6.5 MB  |  image/jpeg                           │     │
│  │  │ [预览图] │  [下载] [在新标签打开]                           │     │
│  │  └─────────┘                                                   │     │
│  │                                                                │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                                                                         │
│  ═══════════════════════════════════════════════════════════════════   │
│  🔧 系统字段 (与上方数据重复，已自动折叠)                    [展开] ▶   │
│  ═══════════════════════════════════════════════════════════════════   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 关键交互说明

#### 1. Asset 卡片组件

```
┌─────────────────────────────────────────────────────────────────┐
│                        Asset 卡片组件                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  ┌──────────┐                                              │ │
│  │  │          │  {id}                              [📋] [🔗] │ │
│  │  │  缩略图   │  {type}                                      │ │
│  │  │  64x64   │  ───────────────────────────────────────     │ │
│  │  │  hover   │  {description}                                │ │
│  │  │  放大    │                                               │ │
│  │  └──────────┘  ▶ details { N Items }    ← 点击展开          │ │
│  │                ▶ visual_profile "..."    ← 截断+tooltip    │ │
│  │                ▶ ref_file { ... }        ← 简化显示         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  缩略图来源：自动从 ref_url 或 ref_file.url 获取                  │
│  点击缩略图：弹出大图预览                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2. 视图切换

```
┌─────────────────────────────────────────────────────────────────┐
│                         视图切换                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [📋 列表] - 默认视图                                            │
│  ├── 每个 Asset 一行，显示缩略图+基本信息                         │
│  ├── 适合快速浏览                                                │
│  └── 支持展开查看详情                                            │
│                                                                 │
│  [🎴 卡片] - 网格视图                                            │
│  ├── 3-4 列网格布局                                              │
│  ├── 突出显示缩略图                                              │
│  └── 适合图片为主的输出                                          │
│                                                                 │
│  [📝 JSON] - 原始视图                                            │
│  ├── 显示原始 JSON 数据                                          │
│  ├── 支持树形展开（参考 Coze）                                    │
│  └── 开发者调试用                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3. 文件字段智能展示

```
┌─────────────────────────────────────────────────────────────────┐
│                      文件字段智能展示                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  原始 JSON (当前 Dify)：                                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  "ref_file": {                                             │ │
│  │    "dify_model_identity": "__dify__file__",                │ │
│  │    "id": null,                                             │ │
│  │    "tenant_id": "00000000-0000-0000-0000-000000000000",    │ │
│  │    "type": "image",                                        │ │
│  │    "transfer_method": "tool_file",                         │ │
│  │    "remote_url": null,                                     │ │
│  │    "related_id": "62c5a931-cc83-492c-9894-ce6e95af580b",  │ │
│  │    "filename": "5e9caf6036c64b028701210674d33180.jpg",     │ │
│  │    "extension": ".jpg",                                    │ │
│  │    "mime_type": "image/jpeg",                              │ │
│  │    "size": 515129,                                         │ │
│  │    "url": "https://ai-hub-api.aiae.ndhy.com/files/too..."  │ │
│  │  }                                                         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  优化后展示：                                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  ref_file:                                                 │ │
│  │  ┌─────────┐  5e9caf6036c6...jpg                          │ │
│  │  │ 🖼️      │  503 KB  |  JPEG                             │ │
│  │  │ [预览]   │  [打开] [复制URL] [查看JSON]                  │ │
│  │  └─────────┘                                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4. 长文本字段处理

```
┌─────────────────────────────────────────────────────────────────┐
│                       长文本字段处理                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  visual_profile 字段示例：                                       │
│                                                                 │
│  折叠状态（默认）：                                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  visual_profile: "国风手绘风，Q版古风风格,小青蛙，翠绿..."   │ │
│  │                                                    [展开] ▶ │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  展开状态：                                                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  visual_profile:                                    [收起] │ │
│  │  ─────────────────────────────────────────────────────     │ │
│  │  国风手绘风，Q版古风风格,小青蛙，翠绿色皮肤，身体圆润，有一个 │ │
│  │  非常突出的圆滚滚的肚子，四肢短小，大而圆的黑色豆豆眼。姿态为 │ │
│  │  四足蹲坐，头顶顶着一小片新鲜的荷叶。除小青蛙外其余部分为     │ │
│  │  白色背景                                                   │ │
│  │                                                    [📋 复制] │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 技术实现要点

| 组件 | 实现方案 |
|------|----------|
| **Asset 卡片** | React 组件，根据 type 字段渲染不同样式 |
| **图片预览** | 懒加载 + 占位符，避免阻塞渲染 |
| **JSON 树** | react-json-view 或自研，支持折叠/搜索 |
| **去重逻辑** | 识别 `text`+`json`+`files` 特征，自动折叠 |
| **视图切换** | 本地状态，不影响数据 |
| **复制功能** | 支持复制单字段、整个对象、格式化 JSON |

### 数据识别规则

```typescript
interface OutputDisplayConfig {
  // 检测是否为工作流工具输出
  isWorkflowToolOutput: (output: any) => boolean;
  // 检测是否为 Dify 文件对象
  isDifyFile: (value: any) => boolean;
  // 检测是否为 Asset 数组
  isAssetArray: (value: any) => boolean;
  // 获取图片预览 URL
  getPreviewUrl: (asset: any) => string | null;
}

const config: OutputDisplayConfig = {
  isWorkflowToolOutput: (output) => {
    return output &&
           typeof output.text === 'string' &&
           Array.isArray(output.json) &&
           Array.isArray(output.files);
  },

  isDifyFile: (value) => {
    return value && value.dify_model_identity === '__dify__file__';
  },

  isAssetArray: (value) => {
    return Array.isArray(value) &&
           value.length > 0 &&
           value[0].id &&
           value[0].type &&
           ['human_character', 'creature_character', 'scene', 'prop'].includes(value[0].type);
  },

  getPreviewUrl: (asset) => {
    return asset.ref_url || asset.ref_file?.url || null;
  }
};
```

#### 问题分析

从 Dify 当前 UI 截图看，输出结构如下：

```json
{
  "text": "{\n  \"reasaon\": \"...\",\n  \"desc\": \"...\"\n}",  // JSON 字符串，转义难读
  "reasoning_content": "",
  "usage": { ... 14 行计费信息 ... },
  "finish_reason": "stop",
  "structured_output": {  // 已解析的结构化数据
    "desc": "这是一个基础的数学事实...",
    "reasaon": "因为根据基本的算术规则..."
  }
}
```

**核心问题不是"没有语法高亮"，而是展示策略不合理**：

| 问题 | 具体表现 | 影响 |
|------|----------|------|
| **信息冗余** | `text` 和 `structured_output` 内容重复 | 视觉干扰 |
| **主次不分** | 用户关心的 `structured_output` 在最下面 | 需要滚动 |
| **`text` 可读性差** | JSON 字符串带 `\n` `\"` 转义 | 根本看不懂 |
| **`usage` 占比过大** | 14 行计费信息，调优时很少关注 | 喧宾夺主 |

#### 优化方案：分区展示 + 智能折叠

```
┌─────────────────────────────────────────────────────────────────┐
│  输出                                              📋 [展开全部] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 📦 结构化输出 (structured_output) ──────────── 默认展开 ─┐   │
│  │                                                           │   │
│  │  {                                                        │   │
│  │    "desc": "这是一个基础的数学事实，适用于大多数...",       │   │
│  │    "reasaon": "因为根据基本的算术规则，1加1等于2。"        │   │
│  │  }                                                        │   │
│  │                                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─ 📝 原始文本 (text) ─────────────────────────── 默认折叠 ─┐   │
│  │  "{\n  \"reasaon\": \"因为根据基本的...\"...}" [点击展开]  │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─ 💰 使用量 (usage) ──────────────────────────── 默认折叠 ─┐   │
│  │  tokens: 322 | price: ¥0.000884 | latency: 2.3s [点击展开] │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─ ℹ️ 元信息 ───────────────────────────────────── 默认折叠 ─┐   │
│  │  finish_reason: stop | reasoning_content: (空) [点击展开]  │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 具体优化规则

| 字段 | 处理方式 | 理由 |
|------|----------|------|
| **structured_output** | 📦 置顶 + 默认展开 | 这是用户最关心的业务数据 |
| **text** | 📝 折叠 + 摘要显示 | 与 structured_output 重复，仅调试时查看 |
| **usage** | 💰 折叠 + 单行摘要 | 显示关键指标（tokens/price/latency）即可 |
| **finish_reason** | ℹ️ 折叠到元信息区 | 正常情况下不需要关注 |
| **reasoning_content** | ℹ️ 空值不显示 | 减少干扰 |

#### 智能检测逻辑

```python
def get_display_priority(output: dict) -> list:
    """决定输出字段的展示优先级和默认状态"""
    sections = []

    # 1. 结构化输出优先
    if "structured_output" in output and output["structured_output"]:
        sections.append({
            "key": "structured_output",
            "label": "📦 结构化输出",
            "expanded": True,  # 默认展开
            "priority": 1
        })

    # 2. 如果有 structured_output，text 就折叠（内容重复）
    if "text" in output:
        sections.append({
            "key": "text",
            "label": "📝 原始文本",
            "expanded": "structured_output" not in output,  # 没有结构化输出时才展开
            "priority": 2
        })

    # 3. usage 折叠，显示摘要
    if "usage" in output:
        usage = output["usage"]
        summary = f"tokens: {usage.get('total_tokens')} | price: ¥{usage.get('total_price')} | latency: {usage.get('latency')}s"
        sections.append({
            "key": "usage",
            "label": "💰 使用量",
            "summary": summary,
            "expanded": False,
            "priority": 3
        })

    # 4. 其他元信息折叠
    meta_fields = ["finish_reason", "reasoning_content"]
    meta = {k: v for k, v in output.items() if k in meta_fields and v}
    if meta:
        sections.append({
            "key": "_meta",
            "label": "ℹ️ 元信息",
            "data": meta,
            "expanded": False,
            "priority": 4
        })

    return sorted(sections, key=lambda x: x["priority"])

---

## Dify 现有单节点调试能力评估

### Dify Cloud 1.5.0+ 已支持功能

根据 Dify 官方文档，当前版本已支持：

| 功能 | 说明 | 文档来源 |
|------|------|----------|
| **单节点测试 (Step Run)** | 可单独测试任何节点，无需运行整个工作流 | [Single Node Testing](https://docs.dify.ai/guides/workflow/single-node-testing) |
| **变量检查器** | 显示工作流中所有数据流，可查看每个节点的输入输出 | [Variable Inspector](https://docs.dify.ai/guides/workflow/variable-inspector) |
| **缓存变量编辑** | 节点输出会缓存在变量检查器中，可编辑这些缓存变量来测试不同场景 | 同上 |
| **由此重新执行** | 使用编辑后的变量值运行下游节点 | 同上 |

### 与需求的差距分析

```
┌─────────────────────────────────────────────────────────────────┐
│                    Dify 现有能力 vs 需求差距                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 已满足：                                                     │
│  ├── 单节点独立运行                                              │
│  ├── 查看节点输入/输出                                           │
│  ├── 编辑缓存变量值                                              │
│  └── 由此重新执行下游节点                                         │
│                                                                 │
│  ⚠️ 部分满足（有限制）：                                          │
│  ├── 缓存仅来自最近一次调试运行                                    │
│  │   └── 不能从任意历史运行记录导入输入数据                        │
│  ├── 无快照管理功能                                               │
│  │   └── 不能保存/命名/复用特定输入数据集                          │
│  └── 变量编辑需手动在 JSON 中修改                                  │
│       └── 复杂嵌套 JSON 编辑体验差                                 │
│                                                                 │
│  ❌ 未满足：                                                      │
│  ├── 提示词版本管理                                               │
│  ├── A/B 版本对比运行                                             │
│  ├── 采样运行（只跑前 N 个镜头）                                   │
│  ├── 节点级缓存（相同输入复用输出）                                 │
│  └── 追踪日志结构化查看（树形展开、搜索、高亮）                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 关键差距：缓存变量的局限性

**用户期望**：从任意历史运行记录中选择输入数据，注入到单节点执行

**Dify 实际**：只能使用最近一次调试运行的缓存变量

```
┌─────────────────────────────────────────────────────────────────┐
│                    缓存变量使用场景对比                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  场景 A：修改提示词后，快速验证效果                                │
│  ├── Dify 支持：✅ 可以使用上次调试的缓存输入，单独运行节点         │
│  └── 典型流程：改提示词 → 单节点运行 → 查看输出 → 迭代             │
│                                                                 │
│  场景 B：复现历史运行中的某个问题                                  │
│  ├── Dify 支持：⚠️ 需要先完整运行一次来填充缓存                    │
│  └── 问题：如果历史运行是 3 小时前的，缓存已被覆盖                  │
│                                                                 │
│  场景 C：对比不同输入下的节点表现                                  │
│  ├── Dify 支持：⚠️ 需要手动编辑变量 JSON                          │
│  └── 问题：复杂 JSON 编辑易出错                                   │
│                                                                 │
│  场景 D：保存"黄金测试用例"输入数据集                              │
│  ├── Dify 支持：❌ 无快照管理功能                                  │
│  └── 问题：每次都要重新准备输入数据                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 哪些调优场景可以直接使用 Dify 现有功能

| 调优场景 | 是否可用 Dify 现有功能 | 说明 |
|----------|------------------------|------|
| 修改提示词后验证单节点效果 | ✅ 可以 | 使用缓存变量 + 单节点运行 |
| 调整节点参数（如温度、top_p） | ✅ 可以 | 单节点运行即可 |
| 修改上游输入验证下游反应 | ✅ 可以 | 编辑缓存变量 + 运行下游节点 |
| 复现历史问题 | ⚠️ 部分可以 | 需要重新运行填充缓存 |
| 对比多个提示词版本 | ❌ 不可以 | 无版本管理和对比功能 |
| 只运行 3 个镜头验证 | ❌ 不可以 | 无采样运行功能 |
| 查看复杂输出结构 | ⚠️ 体验差 | 只有原始 JSON，无结构化视图 |

### 结论

**Dify 现有的单节点调试功能可以解决"修改后快速验证"的核心需求**，但存在以下局限：

1. **缓存管理不灵活**：只有最新一次调试的缓存，无法选择历史运行数据
2. **无版本对比**：不能并排对比不同提示词版本的效果
3. **无采样运行**：迭代节点必须跑完所有数据
4. **输出查看体验差**：复杂 JSON 难以阅读

**建议的增强优先级**：

| 优先级 | 增强功能 | 理由 |
|--------|----------|------|
| P0 | 追踪日志结构化查看 | 现有功能体验太差，影响日常使用 |
| P0 | 从历史运行导入输入数据 | 补齐缓存变量的局限性 |
| P1 | 采样运行 | 大幅缩短迭代时间 |
| P1 | 输入数据快照管理 | 复用测试数据集 |
| P2 | 提示词版本管理 | 对比优化效果 |

---

## 现有能力分析

从截图分析，Dify 当前已支持：

| 能力 | 状态 | 说明 |
|------|------|------|
| 由此重新执行 | ✅ 已有 | 可从某节点重新运行（使用缓存变量） |
| 单节点测试 | ✅ 已有 | 可单独运行节点（Dify 1.5.0+） |
| 变量检查器 | ✅ 已有 | 可查看/编辑缓存变量 |
| 查看追踪日志 | ✅ 已有 | 可查看节点输入输出（但体验差） |
| Ask AI | ✅ 已有 | 可调用 AI 分析 |
| 费用明细 | ✅ 已有 | 可查看 Token 消耗 |
| 节点级耗时 | ✅ 已有 | 显示每个节点耗时 |

**需要增强的能力**：

- 追踪日志结构化查看（树形展开、搜索、高亮）
- 从历史运行导入输入数据（补齐缓存局限）
- 输入数据快照管理
- 提示词版本管理
- 版本对比视图
- 采样运行

---

## 详细功能规格

### 单节点调试 API 规格

```yaml
# POST /console/api/apps/{app_id}/workflows/nodes/{node_id}/debug
Request:
  body:
    input_data: object          # 节点输入数据
    input_source: string        # 输入来源: manual / snapshot / run_history
    snapshot_id: string         # 快照ID（当 input_source=snapshot 时）
    run_id: string              # 运行ID（当 input_source=run_history 时）

Response:
  output_data: object           # 节点输出
  tokens_used: number           # Token 消耗
  duration_ms: number           # 执行耗时
  error: string | null          # 错误信息
```

### 提示词版本管理 API 规格

```yaml
# GET /console/api/apps/{app_id}/workflows/nodes/{node_id}/prompt-versions
Response:
  versions:
    - id: string
      version: number
      remark: string
      created_at: datetime
      is_current: boolean

# POST /console/api/apps/{app_id}/workflows/nodes/{node_id}/prompt-versions
Request:
  body:
    prompt_content: string
    remark: string

# POST /console/api/apps/{app_id}/workflows/nodes/{node_id}/prompt-versions/compare
Request:
  body:
    version_ids: string[]       # 要对比的版本ID列表
    input_snapshot_id: string   # 使用的输入快照
Response:
  results:
    - version_id: string
      output_data: object
      tokens_used: number
      duration_ms: number
```

### 采样运行配置

```yaml
# POST /console/api/apps/{app_id}/workflows/run
Request:
  body:
    inputs: object
    sampling:
      enabled: boolean
      count: number             # 采样数量
      mode: string              # first_n / random / specified
      indices: number[]         # 指定索引（当 mode=specified 时）
      apply_to_nodes: string[]  # 应用采样的迭代节点ID
```

---

## 界面原型

### 单节点调试面板

```
┌─────────────────────────────────────────────────────────────────┐
│  🔧 单节点调试 - 剧本创作                                  [×]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入来源                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ○ 从历史运行导入                                        │    │
│  │    └── 选择运行记录: [#56 - 2024-01-15 14:30 ▼]         │    │
│  │                                                         │    │
│  │  ○ 从快照加载                                            │    │
│  │    └── 选择快照: [无可用快照]                            │    │
│  │                                                         │    │
│  │  ● 手动输入                                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  输入数据                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  {                                                      │    │
│  │    "input": "从前有座山...",                            │    │
│  │    "art_style": "水墨风格",                             │    │
│  │    "lesson_name": "中国神话故事"                        │    │
│  │  }                                                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  [保存为快照]                            [运行] [取消]           │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  输出结果                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  {                                                      │    │
│  │    "script": [                                          │    │
│  │      {"segment": "场景一", "location": "...", ...}      │    │
│  │    ]                                                    │    │
│  │  }                                                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  耗时: 45.2s  |  Token: 9,777  |  费用: ¥0.36                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 版本对比面板

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 提示词版本对比 - 剧本创作                              [×]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  选择版本进行对比（最多3个）                                      │
│  ☑ v3 (当前) - 增加考据和转场要求    2024-01-15                  │
│  ☑ v2 - 增加场景扩写约束            2024-01-14                  │
│  ☐ v1 - 初版                        2024-01-10                  │
│                                                                 │
│  使用输入: [从运行 #56 导入 ▼]           [开始对比运行]           │
│                                                                 │
├───────────────────────────┬─────────────────────────────────────┤
│         v3 (当前)         │              v2                     │
├───────────────────────────┼─────────────────────────────────────┤
│                           │                                     │
│  提示词 Diff:              │  提示词:                            │
│  + 原著核实与大纲补全      │  基础剧本创作要求                    │
│  + 转场衔接规范            │  ...                                │
│  ...                      │                                     │
│                           │                                     │
├───────────────────────────┼─────────────────────────────────────┤
│  输出预览:                 │  输出预览:                           │
│  场景数: 12               │  场景数: 8                           │
│  平均场景长度: 850字       │  平均场景长度: 520字                  │
│                           │                                     │
├───────────────────────────┼─────────────────────────────────────┤
│  性能指标:                 │  性能指标:                           │
│  Token: 9,777             │  Token: 6,200                       │
│  耗时: 45.2s              │  耗时: 32.1s                        │
│  费用: ¥0.36              │  费用: ¥0.23                        │
│                           │                                     │
├───────────────────────────┴─────────────────────────────────────┤
│                                                                 │
│  📝 AI 分析:                                                     │
│  v3 版本生成的场景更丰富（+50%），但 Token 消耗增加 58%。          │
│  建议：如果质量优先，采用 v3；如果成本敏感，可考虑优化 v2。         │
│                                                                 │
│                        [采用 v3]  [采用 v2]  [继续优化]           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 后续迭代路线

```
Phase 1 (MVP) - 目标：调优验证时间 3h → 20min
├── 单节点调试基础功能
├── 节点输入/输出快照保存
├── 从历史运行导入输入
└── 采样运行模式

Phase 2 - 目标：减少无效迭代
├── 提示词版本管理
├── 版本对比运行
└── Diff 视图

Phase 3 - 目标：进一步缩短完整运行时间
├── 节点级缓存
├── 增量运行
└── 并行度调节

Phase 4 - 目标：降低调优门槛
├── AI 优化助手
├── 自动分析报告
└── 智能推荐优化方向
```

---

## 总结

### 核心洞察

| 维度 | 结论 |
|------|------|
| **问题本质** | 不是模型太慢，而是调优流程中存在大量不必要的等待 |
| **影响程度** | 当前：一天 2 次迭代 → 理想：一天 20+ 次迭代，差距 10 倍 |
| **解决思路** | 隔离调试 + 采样验证 + 缓存复用 |
| **MVP 收益** | 单节点调试 + 采样运行 = 调优验证时间从 3h → 23min |

### 预期效果对比

```
┌─────────────────────────────────────────────────────────────────┐
│                        效果对比                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  优化前（当前状态）                                               │
│  ────────────────                                               │
│  09:00  改提示词，启动运行                                        │
│  12:00  运行完成，发现问题                                        │
│  14:00  改提示词，启动运行                                        │
│  17:00  运行完成，发现新问题                                      │
│  → 一天 2 次迭代                                                 │
│                                                                 │
│  优化后（MVP 上线后）                                             │
│  ────────────────                                               │
│  09:00  改提示词                                                 │
│  09:05  单节点调试完成，确认 OK                                   │
│  09:10  改另一处提示词                                           │
│  09:15  单节点调试完成，确认 OK                                   │
│  09:20  启动采样运行（3个镜头）                                   │
│  09:40  采样完成，发现问题                                        │
│  09:45  修改，再次单节点调试                                      │
│  09:50  确认 OK，再次采样运行                                     │
│  10:10  采样 OK，启动完整运行（后台）                              │
│  10:15  继续优化下一个节点...                                     │
│  → 一天 20+ 次迭代                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
