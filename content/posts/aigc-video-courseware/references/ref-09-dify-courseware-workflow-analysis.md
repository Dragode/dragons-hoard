+++
date = '2026-02-07T15:29:04+08:00'
draft = false
title = '参考：Dify课件工作流分析'
tags = ['AI', 'AIGC', 'Dify', '视频生成', '工作流']
categories = ['技术调研']
series = ['AIGC视频课件生成实践']
weight = 109
+++


> 基于 Dify 工作流 DSL 分析
> 整理时间: 2025-02-07

## 目录

1. [工作流概览](#1-工作流概览)
2. [完整工作流流程图](#2-完整工作流流程图)
3. [主工作流详解](#3-主工作流详解)
4. [子工作流详解](#4-子工作流详解)
5. [领域模型提取](#5-领域模型提取)
6. [与业界标准对比](#6-与业界标准对比)
7. [技术架构特点](#7-技术架构特点)

---

## 1. 工作流概览

### 1.1 工作流清单

| 工作流名称 | 类型 | 说明 |
|-----------|------|------|
| AI课件-AIGC自动化工作流-故事演绎 | 主工作流 | 端到端的课件视频生成流程 |
| AIGC-主体素材生产 | 子工作流 | 角色/场景/道具素材生成 |

### 1.2 输入输出

**主工作流输入：**
| 参数 | 类型 | 说明 |
|------|------|------|
| input | string | 剧本大纲 |
| art_style | string | 美术风格设定 |
| draft_url | string | 剪映草稿链接 |
| start_time | number | 开始时间 |
| lesson_name | string | 课程名称 |
| class_name | string | 课时名称 |
| custom_ref | array[file] | 主体参考图（角色/场景/道具） |
| custom_ref_desc | string | 参考图描述 |
| language | string | 目标语言 |
| test | boolean | 测试模式 |

**主工作流输出：**
| 参数 | 类型 | 说明 |
|------|------|------|
| draft_url | string | 生成的剪映草稿链接 |
| story_board | object | 分镜数据结构 |

---

## 2. 完整工作流流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           AI课件-AIGC自动化工作流-故事演绎                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────┐
│   开始   │ ─────────────────────────────────────────────────────────────────────────────┐
│  (Start) │                                                                              │
└────┬─────┘                                                                              │
     │                                                                                    │
     ▼                                                                                    │
┌──────────────────────┐                                                                  │
│     剧本创作         │  ← Gemini 2.5 Pro                                                │
│   (Script Creation)  │    输入: 剧本大纲 + 主体参考图                                    │
│   [LLM Node]         │    输出: 结构化剧本 JSON                                          │
└────┬─────────────────┘                                                                  │
     │                                                                                    │
     ├─────────────────────────────────────────┐                                          │
     │                                         │                                          │
     ▼                                         ▼                                          │
┌──────────────────────┐              ┌──────────────────────┐                            │
│  主体素材生成        │              │根据剧本生成分镜（组）│  ← Gemini 2.5 Pro           │
│ (Asset Generation)   │◀─────────┐  │ (Storyboard Groups)  │                            │
│ [Sub-Workflow Call]  │          │  │   [LLM Node]         │                            │
└────┬─────────────────┘          │  └────┬─────────────────┘                            │
     │                            │       │                                               │
     │  ┌─────────────────────────┘       │                                               │
     │  │ 素材库用于分镜匹配              │                                               │
     ▼  │                                 ▼                                               │
┌───────┴──────────────┐          ┌──────────────────────┐                               │
│   主体素材 JSON      │          │ 分镜（组）JSON String │                               │
│   (Assets Result)    │          │                      │                               │
└──────────────────────┘          └────┬─────────────────┘                               │
                                       │                                                  │
                                       ▼                                                  │
                              ┌──────────────────────────┐                                │
                              │  引用主体生成提示词       │  ← Gemini 2.5 Pro              │
                              │ (Asset-Prompt Binding)   │    整合分镜 + 素材库            │
                              │   [LLM Node]             │    生成 image_prompt/video_prompt│
                              └────┬─────────────────────┘                                │
                                   │                                                      │
                                   ▼                                                      │
                              ┌──────────────────────────┐                                │
                              │   视觉提示词风格化        │  ← Gemini 2.5 Pro              │
                              │ (Style Adaptation)       │    融入美术风格设定             │
                              │   [LLM Node]             │                                │
                              └────┬─────────────────────┘                                │
                                   │                                                      │
                                   ├─────────────────┐                                    │
                                   │                 │                                    │
                                   ▼                 ▼                                    │
                              ┌─────────────┐  ┌──────────────────┐                       │
                              │判断是否需要 │  │ 判断draft_url    │                       │
                              │翻译         │  │ [If-Else]        │                       │
                              │[If-Else]    │  └────┬─────────────┘                       │
                              └──────┬──────┘       │                                     │
                                     │              │ 无现有草稿                          │
                                     ▼              ▼                                     │
                              ┌─────────────┐  ┌──────────────────┐                       │
                              │ 翻译        │  │ 创建视频草稿     │  ← CapCut API         │
                              │[LLM Node]   │  │ [Tool Node]      │                       │
                              └─────────────┘  └────┬─────────────┘                       │
                                                    │                                     │
     ┌──────────────────────────────────────────────┘                                     │
     │                                                                                    │
     ▼                                                                                    │
┌─────────────────────────────────────────────────────────────────────────────┐          │
│                          遍历生成分镜 (Iteration)                            │          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │          │
│  │                                                                       │  │          │
│  │   ┌──────────────┐                                                   │  │          │
│  │   │ 获得分镜信息  │                                                   │  │          │
│  │   │ [Code Node]  │                                                   │  │          │
│  │   └──────┬───────┘                                                   │  │          │
│  │          │                                                           │  │          │
│  │          ▼                                                           │  │          │
│  │   ┌─────────────────────────────┐                                    │  │          │
│  │   │ 判断采用哪种方案生成分镜视频 │                                    │  │          │
│  │   │ [Code Node]                 │                                    │  │          │
│  │   │ i2v-single / i2v-keyframe   │                                    │  │          │
│  │   └──────┬──────────────────────┘                                    │  │          │
│  │          │                                                           │  │          │
│  │          ├──────────────────────────────┐                            │  │          │
│  │          │                              │                            │  │          │
│  │          ▼                              ▼                            │  │          │
│  │   ┌──────────────────┐          ┌──────────────────┐                 │  │          │
│  │   │ 分镜组故事板     │          │ 主体参考生视频    │                 │  │          │
│  │   │ (Storyboard Panel)│          │ (Ref-based Video)│                 │  │          │
│  │   │ [LLM Node]       │          │                  │                 │  │          │
│  │   └──────┬───────────┘          └──────┬───────────┘                 │  │          │
│  │          │                              │                            │  │          │
│  │          ▼                              │                            │  │          │
│  │   ┌─────────────────────────┐          │                            │  │          │
│  │   │ banana生图链接版        │◀─────────┘                            │  │          │
│  │   │ [HTTP Request / Tool]   │                                       │  │          │
│  │   │ (即梦-文/图生图)        │                                       │  │          │
│  │   └──────┬──────────────────┘                                       │  │          │
│  │          │                                                           │  │          │
│  │          ▼                                                           │  │          │
│  │   ┌─────────────────────────┐                                       │  │          │
│  │   │ 即梦图生视频-3.5 Pro    │  ← Doubao Video API                   │  │          │
│  │   │ [Tool Node]             │    i2v-single: 单图生视频              │  │          │
│  │   │                         │    i2v-keyframe: 首尾帧生视频          │  │          │
│  │   └──────┬──────────────────┘                                       │  │          │
│  │          │                                                           │  │          │
│  │          ▼                                                           │  │          │
│  │   ┌─────────────────────────┐                                       │  │          │
│  │   │ 把生成的图片/视频加到    │                                       │  │          │
│  │   │ 镜头组中                 │                                       │  │          │
│  │   │ [Code Node]             │                                       │  │          │
│  │   └──────────────────────────┘                                       │  │          │
│  │                                                                       │  │          │
│  └───────────────────────────────────────────────────────────────────────┘  │          │
└─────────────────────────────────────────────────────────────────────────────┘          │
     │                                                                                    │
     ▼                                                                                    │
┌──────────────────────┐                                                                  │
│    整合输出          │                                                                  │
│   [Code Node]        │                                                                  │
└────┬─────────────────┘                                                                  │
     │                                                                                    │
     ├─────────────────────────────────────────────────────────────────────────────┐      │
     │                                                                             │      │
     ▼                                                                             ▼      │
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐            │
│  批量添加图片       │    │   批量添加字幕      │    │   批量添加视频      │            │
│ [Tool Node]         │    │  [Tool Node]        │    │  [Tool Node]        │            │
│ CapCut API          │    │  CapCut API         │    │  CapCut API         │            │
└────┬────────────────┘    └────┬────────────────┘    └────┬────────────────┘            │
     │                          │                          │                              │
     └──────────────────────────┴──────────────────────────┘                              │
                                │                                                         │
                                ▼                                                         │
                         ┌──────────────┐                                                 │
                         │    结束      │ ◀───────────────────────────────────────────────┘
                         │   (End)      │
                         │  draft_url   │
                         │  story_board │
                         └──────────────┘
```

---

## 3. 主工作流详解

### 3.1 节点清单

| 序号 | 节点标题 | 节点类型 | 说明 |
|------|---------|----------|------|
| 1 | 开始 | start | 工作流入口，接收输入参数 |
| 2 | 剧本创作 | llm | 使用 Gemini 2.5 Pro 生成结构化剧本 |
| 3 | 主体素材生成 | workflow (子工作流) | 调用子工作流生成角色/场景/道具素材 |
| 4 | 主题素材 json string | code | 格式化素材数据 |
| 5 | 判断是否有主体参考 | if-else | 判断是否需要生成主体素材 |
| 6 | 根据剧本生成分镜（组） | llm | Gemini 2.5 Pro 生成分镜组结构 |
| 7 | 分镜（组）json string | code | 格式化分镜数据 |
| 8 | 引用主体生成提示词 | llm | 将分镜与素材库绑定，生成 prompt |
| 9 | 视觉提示词风格化 | llm | 融入美术风格设定 |
| 10 | 提示词json string | code | 格式化提示词数据 |
| 11 | 分镜长度判断 | code | 校验分镜数量一致性 |
| 12 | 判断采用哪种方案生成分镜视频 | code | i2v-single / i2v-keyframe 选择 |
| 13 | random seed | code | 生成随机种子确保可复现性 |
| 14 | 判断draft_url | if-else | 判断是否已有剪映草稿 |
| 15 | 创建视频草稿 | tool | CapCut API 创建草稿 |
| 16 | 生成剪映数据info | code | 准备剪映数据结构 |
| 17 | 遍历生成分镜 | iteration | 遍历每个分镜生成图片/视频 |
| 18 | 获得分镜信息 | code | 提取当前分镜数据 |
| 19 | 分镜组故事板 | llm | 生成故事板参考图 |
| 20 | 生成分镜组故事版图片 | iteration | 嵌套迭代生成图片 |
| 21 | 获取故事版信息 | code | 提取故事版数据 |
| 22 | 即梦-文/图生图-4.x版本 | tool | 即梦图片生成 API |
| 23 | 获取即梦地址 | code | 获取生成结果 URL |
| 24 | 判断出图是否成功 | if-else | 校验图片生成状态 |
| 25 | banana生图链接版 | http-request | 备选图片生成服务 |
| 26 | 把生成的图片加到镜头组中 | code | 整合图片到分镜 |
| 27 | 即梦图生视频-3.5 Pro | tool | 即梦视频生成 API (i2v) |
| 28 | HTTP 请求下载图片 | http-request | 下载远程图片 |
| 29 | 主体参考生视频 | tool | 基于参考图的视频生成 |
| 30 | 整合输出 | code | 整合所有生成结果 |
| 31 | 批量添加图片 | tool | CapCut API 添加图片素材 |
| 32 | 批量添加字幕 | tool | CapCut API 添加字幕 |
| 33 | 批量添加视频 | tool | CapCut API 添加视频片段 |
| 34 | 对字幕进行分割 | code | 字幕时间轴处理 |
| 35 | 根据语种进行翻译 | if-else | 多语言处理分支 |
| 36 | 翻译 | llm | 字幕翻译 |
| 37 | 结束 | end | 输出 draft_url 和 story_board |

### 3.2 核心 LLM 节点详解

#### 3.2.1 剧本创作节点

**模型**: Gemini 2.5 Pro
**功能**: 基于剧本大纲和主体参考图，生成结构化剧本

**输出结构**:
```json
{
  "script": [
    {
      "scene": "场景描述",
      "characters": ["角色列表"],
      "dialogue": "对话内容",
      "action": "动作描述"
    }
  ]
}
```

#### 3.2.2 根据剧本生成分镜（组）节点

**模型**: Gemini 2.5 Pro
**功能**: 将剧本转换为专业分镜结构

**输出结构**:
```json
{
  "total_duration": "总时长",
  "total_shots": "总镜头数",
  "shot_groups": [
    {
      "group_id": "SG-001",
      "group_name": "分镜组名称",
      "duration": 30,
      "scene": "场景",
      "time": "时间",
      "lighting": "光影设定",
      "atmosphere": "氛围",
      "characters": ["角色"],
      "props": ["道具"],
      "audio": "音频设定",
      "shots": [
        {
          "shot_id": "SG-001-01",
          "shot_type": "近景/中景/远景/特写",
          "camera_angle": "平视/俯拍/仰拍",
          "camera_movement": "固定/缓推/缓拉/横摇",
          "duration": 5,
          "subject": "主体",
          "action": "动作描述",
          "background": "背景描述",
          "visual_focus": "视觉焦点",
          "transition": "转场方式",
          "narration": "旁白/对话",
          "narration_type": "dialogue/voiceover/narrator",
          "narrator": "说话者",
          "image_prompt": "图像生成提示词"
        }
      ]
    }
  ]
}
```

#### 3.2.3 引用主体生成提示词节点

**模型**: Gemini 2.5 Pro
**功能**: 将分镜与素材库资产绑定，生成可直接用于 AI 生图/生视频的提示词

**核心逻辑**:
1. 解析分镜组的 scene_dna、character_anchors
2. 从 characters_in_frame 匹配素材库角色
3. 从 visible_fixed_elements 匹配道具/元素
4. 整合生成 image_prompt 和 video_prompt
5. 判断 generation_method (i2v-single / i2v-keyframe)

**输出字段**:
```json
{
  "idx": "SG-001-01",
  "description": "画面描述",
  "ref_assets": ["asset_id_1", "asset_id_2"],
  "generation_method": "i2v-single | i2v-keyframe",
  "image_prompt": "图像提示词（整合场景DNA+角色锚点+动作）",
  "image_prompt_end": "尾帧提示词（仅 i2v-keyframe）",
  "video_prompt": "视频提示词（整合运镜+动作+配音）",
  "video_duration": 5,
  "style": "风格描述",
  "narration": "旁白内容",
  "narration_type": "配音类型",
  "narrator": "说话者",
  "voice_desc": "声音描述"
}
```

#### 3.2.4 视觉提示词风格化节点

**模型**: Gemini 2.5 Pro
**功能**: 将分镜提示词与美术风格融合

**核心理念**: 不是简单追加风格关键词，而是用目标风格的原生语言体系重构提示词

**受保护字段** (禁止修改):
- narration
- narrator
- voice_desc
- narration_type

---

## 4. 子工作流详解

### 4.1 AIGC-主体素材生产

**功能**: 生成角色、场景、道具的视觉素材

**输入参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| script | string | 剧本文本 |
| custom_ref | array[file] | 自定义参考图 |
| custom_ref_desc | string | 参考图描述 |
| art_style | string | 美术风格 |

**输出参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| assets_result | array | 素材列表 |

**素材数据结构**:
```json
{
  "id": "asset_001",
  "type": "human_character | creature_character | scene | prop",
  "name": "素材名称",
  "visual_profile": {
    "appearance": "外观描述",
    "clothing": "服装描述",
    "distinctive_features": "特征标记"
  },
  "ref_file": "参考图文件",
  "ref_url": "生成图片URL",
  "prompt": "生成提示词"
}
```

**工作流程**:
```
开始 → 分析参考主体(LLM) → 遍历资产 → 即梦/悠船文生图 → 结束
         ↓
    Gemini 2.5 Pro
    多模态视觉分析
```

---

## 5. 领域模型提取

### 5.1 核心领域实体

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         课件视频生成领域模型                             │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│   课程 (Course)  │
│   • lesson_name  │
│   • class_name   │
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────┐
│  剧本 (Script)   │
│   • input        │ ← 剧本大纲
│   • art_style    │ ← 美术风格
│   • language     │ ← 目标语言
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    主体素材库 (Asset Library)                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │
│  │ 角色 Character  │ │ 场景 Scene      │ │ 道具 Prop       │        │
│  │ • id            │ │ • id            │ │ • id            │        │
│  │ • type          │ │ • type          │ │ • type          │        │
│  │ • visual_profile│ │ • visual_profile│ │ • visual_profile│        │
│  │ • ref_url       │ │ • ref_url       │ │ • ref_url       │        │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘        │
└──────────────────────────────────────────────────────────────────────┘
         │
         │ 引用
         ▼
┌──────────────────┐
│分镜组 (ShotGroup)│
│  • group_id      │ (SG-001)
│  • group_name    │
│  • scene_dna     │ ← 场景基因（光影/氛围/色彩）
│  • character_anchors │ ← 角色锚点（外观锁定/位置锁定）
│  • duration      │
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         分镜 (Shot)                                   │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 基础属性                                                        │  │
│  │ • shot_id (SG-001-01)                                          │  │
│  │ • shot_type (远景/全景/中景/近景/特写/大特写)                   │  │
│  │ • camera_angle (平视/俯拍/仰拍/斜拍)                            │  │
│  │ • camera_movement (固定/缓推/缓拉/横摇/跟拍/手持)               │  │
│  │ • duration (秒)                                                 │  │
│  │ • composition (三分法/中心/对角线)                               │  │
│  └────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 内容描述                                                        │  │
│  │ • subject (主体)                                                │  │
│  │ • action (动作描述，含参考镜引用)                               │  │
│  │ • characters_in_frame (画内角色)                                │  │
│  │ • characters_off_frame (画外角色)                               │  │
│  │ • visible_fixed_elements (可见固定元素)                         │  │
│  │ • background (背景描述)                                         │  │
│  │ • visual_focus (视觉焦点)                                       │  │
│  └────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 配音系统                                                        │  │
│  │ • narration (旁白/对话内容)                                     │  │
│  │ • narration_type (dialogue/voiceover/narrator/inner/"")         │  │
│  │ • narrator (说话者)                                             │  │
│  │ • voice_desc (声音描述: 音域+音色+气质)                         │  │
│  └────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 生成提示词                                                      │  │
│  │ • image_prompt (图像提示词 - 首帧)                              │  │
│  │ • image_prompt_end (图像提示词 - 尾帧，仅 i2v-keyframe)         │  │
│  │ • video_prompt (视频提示词)                                     │  │
│  │ • style (风格描述)                                              │  │
│  └────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 生成配置                                                        │  │
│  │ • generation_method (i2v-single / i2v-keyframe)                 │  │
│  │ • ref_assets (引用资产ID列表)                                   │  │
│  │ • transition (转场方式)                                         │  │
│  └────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 生成结果                                                        │  │
│  │ • image_url (生成图片URL)                                       │  │
│  │ • video_url (生成视频URL)                                       │  │
│  │ • status (pending/processing/completed/failed)                  │  │
│  └────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────┘
         │
         │ 合成
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      剪映草稿 (CapCut Draft)                          │
│  • draft_url                                                         │
│  • start_time                                                        │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │
│  │ 图片轨道      │  │ 视频轨道      │  │ 字幕轨道      │            │
│  │ (Image Track) │  │ (Video Track) │  │ (Text Track)  │            │
│  └───────────────┘  └───────────────┘  └───────────────┘            │
└──────────────────────────────────────────────────────────────────────┘
```

### 5.2 视频生成方案

| 方案代号 | 输入 | 适用场景 | 判断信号词 |
|---------|------|---------|-----------|
| `i2v-single` | 1张图片 | 主体静止、环境氛围变化、循环动作、对话镜头 | 站在、坐在、看着、注视、说、问、答 |
| `i2v-keyframe` | 2张图片（首帧+尾帧） | 状态转变、位置移动、姿态变化、情绪转折 | 走向、移动、转身、站起、从...到...、渐渐 |

### 5.3 场景 DNA 结构

```json
{
  "scene_dna": {
    "prompt_prefix": "场景基础描述（强制作为 prompt 开头）",
    "lighting_setup": "光影设置（方向、色温、质感）",
    "weather_atmosphere": "天气/氛围",
    "color_palette": "色彩基调",
    "architecture_style": "建筑/画面风格",
    "fixed_elements": [
      {
        "ref_id": "REF-A",
        "name": "元素名称",
        "position": "位置",
        "appearance": "外观"
      }
    ],
    "camera_constraint": "机位限制和轴线规则"
  }
}
```

### 5.4 角色锚点结构

```json
{
  "character_anchors": {
    "角色名": {
      "appearance_lock": "角色外观锁定描述",
      "screen_position_lock": "镜头位置锁定（镜头左/右侧）",
      "facing_direction": "面朝方向"
    }
  }
}
```

---

## 6. 与业界标准对比

### 6.1 内容层级结构对比

| 业界标准 | Dify 工作流实现 | Huobao Drama | 对应关系 |
|---------|----------------|--------------|---------|
| Video/Project | Course (课程) | Drama | ✅ 等价 |
| Story/Episode | Script (剧本) | Episode | ✅ 等价 |
| Scene | ShotGroup (分镜组) | Scene | ✅ 等价 |
| Shot | Shot (分镜) | Storyboard | ✅ 等价 |
| Keyframe | image_prompt_end | FramePrompt | ✅ 等价 |

### 6.2 生产流程对比

```
业界四阶段流程:
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ PRE-PRODUCTION│───▶│  PRODUCTION   │───▶│POST-PRODUCTION│───▶│   DELIVERY    │
│    前期制作    │    │    拍摄制作    │    │    后期制作    │    │    交付分发    │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘

Dify 工作流实现:
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  剧本创作      │───▶│  素材生成     │───▶│  分镜生成     │───▶│  剪映合成     │
│  + 主体素材    │    │  (AI生图)     │    │  (AI生视频)   │    │  (CapCut)     │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
   ↑                    ↑                    ↑                    ↑
   前期制作              制作阶段             后期制作              交付
```

### 6.3 AI 生成流水线对比

| 业界 AI Pipeline 阶段 | Dify 工作流节点 | 说明 |
|---------------------|----------------|------|
| INPUT (输入层) | 开始节点 | 剧本大纲、参考图、美术风格 |
| TEXT (文本层) | 剧本创作 | Gemini 2.5 Pro 生成结构化剧本 |
| TEXT (文本层) | 根据剧本生成分镜（组） | 分镜脚本生成 |
| TEXT (文本层) | 引用主体生成提示词 | Prompt Engineering |
| VISUAL (视觉层) | 主体素材生成 | 角色/场景/道具 图像生成 |
| VISUAL (视觉层) | 即梦-文/图生图 | 分镜图像生成 |
| VISUAL (视觉层) | 即梦图生视频 | Image-to-Video 生成 |
| AUDIO (音频层) | voice_desc + narration | TTS 配音系统预设 |
| ASSEMBLY (合成层) | 批量添加图片/视频/字幕 | CapCut API 时间线编排 |

### 6.4 独特创新点

Dify 工作流相比传统方案的创新:

| 创新点 | 说明 |
|-------|------|
| **场景 DNA** | 将场景的光影、氛围、色彩等抽象为可复用的"基因"模板 |
| **角色锚点** | 通过 appearance_lock + screen_position_lock 确保角色视觉一致性 |
| **参考镜引用** | 在 action 中使用 "以SG-001-01镜为参考" 实现跨镜头连续性 |
| **i2v-keyframe** | 首尾帧控制实现平滑状态转换，超越单图生视频 |
| **风格化引擎** | 不是简单追加风格词，而是用风格原生语言重构提示词 |
| **CapCut 集成** | 直接输出到专业剪辑软件，无需二次导入 |

### 6.5 与 Huobao Drama 的差异

| 方面 | Dify 工作流 | Huobao Drama |
|------|------------|--------------|
| 部署方式 | 可视化工作流编排 | 代码实现 |
| 灵活性 | 节点可自由组合 | 固定流程 |
| 时间线编辑 | 通过 CapCut API | 内置 Timeline 组件 |
| 状态管理 | Dify 内置 | 自定义状态机 |
| 素材管理 | 工作流变量传递 | Asset 实体 + 数据库 |
| 多语言 | 内置翻译节点 | 需额外实现 |

---

## 7. 技术架构特点

### 7.1 工作流 DSL 结构

```yaml
app:
  mode: workflow
  name: "工作流名称"

workflow:
  graph:
    edges:          # 节点连接关系
      - source: "节点1"
        target: "节点2"
    nodes:          # 节点定义
      - id: "节点ID"
        type: "start|llm|code|tool|if-else|iteration|end"
        data:
          title: "节点标题"
          # 节点特定配置
```

### 7.2 节点类型

| 节点类型 | 用途 | 典型配置 |
|---------|------|---------|
| start | 工作流入口 | variables (输入变量定义) |
| llm | 大模型调用 | model, prompt_template, structured_output |
| code | Python 代码执行 | code, variables, outputs |
| tool | 外部工具调用 | tool_name, tool_parameters |
| if-else | 条件分支 | conditions, cases |
| iteration | 循环迭代 | iterator_selector, output_selector |
| http-request | HTTP 请求 | method, url, headers, body |
| end | 工作流出口 | outputs (输出变量) |

### 7.3 外部服务集成

| 服务 | 用途 | 集成方式 |
|------|------|---------|
| Gemini 2.5 Pro | 文本生成（剧本/分镜/提示词） | LLM Node |
| 即梦 (JiMeng/Doubao) | 图片生成、视频生成 | Tool Node |
| 悠船 (Youchuan) | 图片生成（备选） | Tool Node |
| CapCut API | 剪映草稿操作 | Tool Node |
| AI Hub Plugin | 统一 AI 服务网关 | Dify Plugin |

### 7.4 插件依赖

```yaml
dependencies:
  - plugin_unique_identifier: aict/ai_hub:3.0.2
    # AI Hub 统一网关，支持多种 AI 模型
  - plugin_unique_identifier: aict/capcut-assistant:0.0.4
    # CapCut 剪映 API 集成
```

---

## 参考资料

- Dify 工作流文档: https://docs.dify.ai/
- 即梦 API 文档: https://www.volcengine.com/docs/
- CapCut/剪映开放平台: https://open.lv.ulikecam.com/
- 业界视频制作领域模型: [industry-video-production-domain-model.md](./industry-video-production-domain-model.md)
