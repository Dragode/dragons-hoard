+++
date = '2026-02-07T15:29:04+08:00'
draft = false
title = 'AI课件视频工作流内部现状分析'
tags = ['AI', 'AIGC', 'Dify', '视频生成', '工作流']
categories = ['技术调研']
series = ['AIGC视频课件生成实践']
weight = 4
+++


> 基于 Dify 工作流 DSL 分析和平台能力梳理
> 分析日期：2026-02-07

---

## 1. 概述

本文档基于以下输入完成：
- Dify 平台能力清单（参见 `02-dify-platform-capabilities.md`）
- AI 课件视频生成工作流 DSL 分析（内部文档 ref-09）
- huobao-drama 开源项目对比

---

## 2. 工作流架构总览

### 2.1 工作流清单

| 工作流名称 | 类型 | 说明 |
|-----------|------|------|
| AI课件-AIGC自动化工作流-故事演绎 | 主工作流 | 端到端的课件视频生成流程（37个节点） |
| AIGC-主体素材生产 | 子工作流 | 角色/场景/道具素材生成 |

### 2.2 工作流输入输出

**主工作流输入：**

| 参数 | 类型 | 说明 |
|------|------|------|
| input | string | 剧本大纲 |
| art_style | string | 美术风格设定 |
| draft_url | string | 剪映草稿链接 |
| start_time | number | 开始时间 |
| lesson_name | string | 课程名称 |
| class_name | string | 课时名称 |
| custom_ref | array[file] | 主体参考图（角色/场景/道具） |
| custom_ref_desc | string | 参考图描述 |
| language | string | 目标语言 |
| test | boolean | 测试模式 |

**主工作流输出：**

| 参数 | 类型 | 说明 |
|------|------|------|
| draft_url | string | 生成的剪映草稿链接 |
| story_board | object | 分镜数据结构 |

### 2.3 工作流流程图

```
┌──────────┐
│   开始   │
└────┬─────┘
     │
     ▼
┌──────────────────────┐
│     剧本创作         │  ← Gemini 2.5 Pro
│   (Script Creation)  │    输入: 剧本大纲 + 主体参考图
└────┬─────────────────┘    输出: 结构化剧本 JSON
     │
     ├──────────────────────────────────┐
     │                                  │
     ▼                                  ▼
┌──────────────────────┐      ┌──────────────────────┐
│  主体素材生成        │      │根据剧本生成分镜（组）│  ← Gemini 2.5 Pro
│ (Asset Generation)   │◀──┐  │ (Storyboard Groups)  │
│ [子工作流调用]       │   │  └────┬─────────────────┘
└────┬─────────────────┘   │       │
     │                     │       │
     ▼                     │       ▼
┌────────────────┐         │  ┌──────────────────────┐
│ 主体素材 JSON  │─────────┘  │ 引用主体生成提示词   │  ← Gemini 2.5 Pro
└────────────────┘            │ (Asset-Prompt Bind)  │
                              └────┬─────────────────┘
                                   │
                                   ▼
                              ┌──────────────────────┐
                              │ 视觉提示词风格化     │  ← Gemini 2.5 Pro
                              │ (Style Adaptation)   │
                              └────┬─────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    遍历生成分镜 (Iteration)                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 获得分镜信息 → 判断生成方案 → 故事板生成 → 图片生成 → 视频生成│ │
│  │      ↓              ↓                                      │ │
│  │    Code        i2v-single /                                │ │
│  │                i2v-keyframe                                │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      CapCut 合成阶段                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 批量添加图片 │  │ 批量添加字幕 │  │ 批量添加视频 │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
     │
     ▼
┌──────────┐
│   结束   │ → draft_url + story_board
└──────────┘
```

---

## 3. 核心节点详解

### 3.1 节点清单（37个节点）

| 序号 | 节点标题 | 节点类型 | 说明 |
|------|---------|----------|------|
| 1 | 开始 | start | 工作流入口，接收输入参数 |
| 2 | 剧本创作 | llm | Gemini 2.5 Pro 生成结构化剧本 |
| 3 | 主体素材生成 | workflow | 调用子工作流生成角色/场景/道具素材 |
| 4 | 主题素材 json string | code | 格式化素材数据 |
| 5 | 判断是否有主体参考 | if-else | 判断是否需要生成主体素材 |
| 6 | 根据剧本生成分镜（组） | llm | Gemini 2.5 Pro 生成分镜组结构 |
| 7 | 分镜（组）json string | code | 格式化分镜数据 |
| 8 | 引用主体生成提示词 | llm | 将分镜与素材库绑定，生成 prompt |
| 9 | 视觉提示词风格化 | llm | 融入美术风格设定 |
| 10 | 提示词json string | code | 格式化提示词数据 |
| 11 | 分镜长度判断 | code | 校验分镜数量一致性 |
| 12 | 判断采用哪种方案生成分镜视频 | code | i2v-single / i2v-keyframe 选择 |
| 13 | random seed | code | 生成随机种子确保可复现性 |
| 14 | 判断draft_url | if-else | 判断是否已有剪映草稿 |
| 15 | 创建视频草稿 | tool | CapCut API 创建草稿 |
| 16 | 生成剪映数据info | code | 准备剪映数据结构 |
| 17 | 遍历生成分镜 | iteration | 遍历每个分镜生成图片/视频 |
| 18 | 获得分镜信息 | code | 提取当前分镜数据 |
| 19 | 分镜组故事板 | llm | 生成故事板参考图 |
| 20 | 生成分镜组故事版图片 | iteration | 嵌套迭代生成图片 |
| 21 | 获取故事版信息 | code | 提取故事版数据 |
| 22 | 即梦-文/图生图-4.x版本 | tool | 即梦图片生成 API |
| 23 | 获取即梦地址 | code | 获取生成结果 URL |
| 24 | 判断出图是否成功 | if-else | 校验图片生成状态 |
| 25 | banana生图链接版 | http-request | 备选图片生成服务 |
| 26 | 把生成的图片加到镜头组中 | code | 整合图片到分镜 |
| 27 | 即梦图生视频-3.5 Pro | tool | 即梦视频生成 API (i2v) |
| 28 | HTTP 请求下载图片 | http-request | 下载远程图片 |
| 29 | 主体参考生视频 | tool | 基于参考图的视频生成 |
| 30 | 整合输出 | code | 整合所有生成结果 |
| 31 | 批量添加图片 | tool | CapCut API 添加图片素材 |
| 32 | 批量添加字幕 | tool | CapCut API 添加字幕 |
| 33 | 批量添加视频 | tool | CapCut API 添加视频片段 |
| 34 | 对字幕进行分割 | code | 字幕时间轴处理 |
| 35 | 根据语种进行翻译 | if-else | 多语言处理分支 |
| 36 | 翻译 | llm | 字幕翻译 |
| 37 | 结束 | end | 输出 draft_url 和 story_board |

### 3.2 核心 LLM 节点 Prompt 设计

#### 3.2.1 剧本创作节点

**模型**: Gemini 2.5 Pro
**功能**: 基于剧本大纲和主体参考图，生成结构化剧本

**输出结构**:
```json
{
  "script": [
    {
      "scene": "场景描述",
      "characters": ["角色列表"],
      "dialogue": "对话内容",
      "action": "动作描述"
    }
  ]
}
```

#### 3.2.2 分镜组生成节点

**模型**: Gemini 2.5 Pro
**功能**: 将剧本转换为专业分镜结构

**输出结构**:
```json
{
  "total_duration": "总时长",
  "total_shots": "总镜头数",
  "shot_groups": [
    {
      "group_id": "SG-001",
      "group_name": "分镜组名称",
      "duration": 30,
      "scene": "场景",
      "time": "时间",
      "lighting": "光影设定",
      "atmosphere": "氛围",
      "characters": ["角色"],
      "props": ["道具"],
      "shots": [
        {
          "shot_id": "SG-001-01",
          "shot_type": "近景/中景/远景/特写",
          "camera_angle": "平视/俯拍/仰拍",
          "camera_movement": "固定/缓推/缓拉/横摇",
          "duration": 5,
          "subject": "主体",
          "action": "动作描述",
          "background": "背景描述",
          "visual_focus": "视觉焦点",
          "transition": "转场方式",
          "narration": "旁白/对话",
          "narration_type": "dialogue/voiceover/narrator",
          "narrator": "说话者"
        }
      ]
    }
  ]
}
```

#### 3.2.3 引用主体生成提示词节点

**模型**: Gemini 2.5 Pro
**功能**: 将分镜与素材库资产绑定，生成 AI 生图/生视频的提示词

**核心逻辑**:
1. 解析分镜组的 scene_dna、character_anchors
2. 从 characters_in_frame 匹配素材库角色
3. 从 visible_fixed_elements 匹配道具/元素
4. 整合生成 image_prompt 和 video_prompt
5. 判断 generation_method (i2v-single / i2v-keyframe)

**输出字段**:
```json
{
  "idx": "SG-001-01",
  "description": "画面描述",
  "ref_assets": ["asset_id_1", "asset_id_2"],
  "generation_method": "i2v-single | i2v-keyframe",
  "image_prompt": "图像提示词（整合场景DNA+角色锚点+动作）",
  "image_prompt_end": "尾帧提示词（仅 i2v-keyframe）",
  "video_prompt": "视频提示词（整合运镜+动作+配音）",
  "video_duration": 5,
  "style": "风格描述",
  "narration": "旁白内容",
  "narration_type": "配音类型",
  "narrator": "说话者",
  "voice_desc": "声音描述"
}
```

---

## 4. 领域模型

### 4.1 核心实体关系

```
┌──────────────────┐
│   课程 (Course)  │
│   • lesson_name  │
│   • class_name   │
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────┐
│  剧本 (Script)   │
│   • input        │ ← 剧本大纲
│   • art_style    │ ← 美术风格
│   • language     │ ← 目标语言
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    主体素材库 (Asset Library)                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │
│  │ 角色 Character  │ │ 场景 Scene      │ │ 道具 Prop       │        │
│  │ • id            │ │ • id            │ │ • id            │        │
│  │ • type          │ │ • type          │ │ • type          │        │
│  │ • visual_profile│ │ • visual_profile│ │ • visual_profile│        │
│  │ • ref_url       │ │ • ref_url       │ │ • ref_url       │        │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘        │
└──────────────────────────────────────────────────────────────────────┘
         │
         │ 引用
         ▼
┌──────────────────┐
│分镜组 (ShotGroup)│
│  • group_id      │ (SG-001)
│  • scene_dna     │ ← 场景基因
│  • character_anchors │ ← 角色锚点
│  • duration      │
└────────┬─────────┘
         │ 1:N
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         分镜 (Shot)                                   │
│  • shot_id (SG-001-01)                                               │
│  • shot_type / camera_angle / camera_movement / duration             │
│  • subject / action / background / visual_focus                      │
│  • narration / narration_type / narrator / voice_desc                │
│  • image_prompt / image_prompt_end / video_prompt                    │
│  • generation_method (i2v-single / i2v-keyframe)                     │
│  • image_url / video_url / status                                    │
└──────────────────────────────────────────────────────────────────────┘
         │
         │ 合成
         ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      剪映草稿 (CapCut Draft)                          │
│  • draft_url                                                         │
│  • 图片轨道 / 视频轨道 / 字幕轨道                                     │
└──────────────────────────────────────────────────────────────────────┘
```

### 4.2 与 huobao-drama 领域模型对比

| Dify 工作流实体 | huobao-drama 实体 | 对应关系 |
|----------------|------------------|---------|
| Course (课程) | Drama | ✅ 等价 |
| Script (剧本) | Episode | ✅ 等价 |
| ShotGroup (分镜组) | Scene | ✅ 等价 |
| Shot (分镜) | Storyboard | ✅ 等价 |
| Asset (素材) | Character/Scene/Prop | ✅ 等价 |

---

## 5. Dify 特有概念

### 5.1 场景 DNA (scene_dna)

场景 DNA 是 Dify 工作流的创新概念，将场景的视觉特征抽象为可复用的"基因"模板：

```json
{
  "scene_dna": {
    "prompt_prefix": "场景基础描述（强制作为 prompt 开头）",
    "lighting_setup": "光影设置（方向、色温、质感）",
    "weather_atmosphere": "天气/氛围",
    "color_palette": "色彩基调",
    "architecture_style": "建筑/画面风格",
    "fixed_elements": [
      {
        "ref_id": "REF-A",
        "name": "元素名称",
        "position": "位置",
        "appearance": "外观"
      }
    ],
    "camera_constraint": "机位限制和轴线规则"
  }
}
```

**作用**：确保同一分镜组内所有镜头的场景视觉一致性。

### 5.2 角色锚点 (character_anchors)

角色锚点用于保持角色在跨镜头中的视觉一致性：

```json
{
  "character_anchors": {
    "角色名": {
      "appearance_lock": "角色外观锁定描述",
      "screen_position_lock": "镜头位置锁定（镜头左/右侧）",
      "facing_direction": "面朝方向"
    }
  }
}
```

**作用**：解决 AI 生成图片/视频时角色外观不一致的问题。

### 5.3 视频生成方案

| 方案代号 | 输入 | 适用场景 | 判断信号词 |
|---------|------|---------|-----------|
| `i2v-single` | 1张图片 | 主体静止、环境氛围变化、循环动作、对话镜头 | 站在、坐在、看着、注视、说、问、答 |
| `i2v-keyframe` | 2张图片（首帧+尾帧） | 状态转变、位置移动、姿态变化、情绪转折 | 走向、移动、转身、站起、从...到...、渐渐 |

---

## 6. 外部服务集成

### 6.1 服务清单

| 服务 | 用途 | 集成方式 |
|------|------|---------|
| **Gemini 2.5 Pro** | 文本生成（剧本/分镜/提示词） | LLM Node |
| **即梦 (JiMeng/Doubao)** | 图片生成、视频生成 | Tool Node |
| **悠船 (Youchuan)** | 图片生成（备选） | Tool Node |
| **CapCut API** | 剪映草稿操作 | Tool Node |
| **AI Hub Plugin** | 统一 AI 服务网关 | Dify Plugin |

### 6.2 插件依赖

```yaml
dependencies:
  - plugin_unique_identifier: aict/ai_hub:3.0.2
    # AI Hub 统一网关，支持多种 AI 模型
  - plugin_unique_identifier: aict/capcut-assistant:0.0.4
    # CapCut 剪映 API 集成
```

---

## 7. 与业界对比分析

### 7.1 生产流程对比

```
业界四阶段流程:
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ PRE-PRODUCTION│───▶│  PRODUCTION   │───▶│POST-PRODUCTION│───▶│   DELIVERY    │
│    前期制作    │    │    拍摄制作    │    │    后期制作    │    │    交付分发    │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘

Dify 工作流实现:
┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  剧本创作      │───▶│  素材生成     │───▶│  分镜生成     │───▶│  剪映合成     │
│  + 主体素材    │    │  (AI生图)     │    │  (AI生视频)   │    │  (CapCut)     │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
```

### 7.2 与 huobao-drama 的差异

| 方面 | Dify 工作流 | huobao-drama |
|------|------------|--------------|
| **部署方式** | 可视化工作流编排 | 代码实现 |
| **灵活性** | 节点可自由组合 | 固定流程 |
| **时间线编辑** | 通过 CapCut API | 内置 Timeline 组件 |
| **状态管理** | Dify 内置 | 自定义状态机 |
| **素材管理** | 工作流变量传递 | Asset 实体 + 数据库 |
| **多语言** | 内置翻译节点 | 需额外实现 |
| **调试能力** | Dify 控制台 | 日志 + 代码调试 |

### 7.3 Dify 工作流独特创新

| 创新点 | 说明 |
|-------|------|
| **场景 DNA** | 将场景的光影、氛围、色彩等抽象为可复用的"基因"模板 |
| **角色锚点** | 通过 appearance_lock + screen_position_lock 确保角色视觉一致性 |
| **参考镜引用** | 在 action 中使用 "以SG-001-01镜为参考" 实现跨镜头连续性 |
| **i2v-keyframe** | 首尾帧控制实现平滑状态转换，超越单图生视频 |
| **风格化引擎** | 不是简单追加风格词，而是用风格原生语言重构提示词 |
| **CapCut 集成** | 直接输出到专业剪辑软件，无需二次导入 |

---

## 8. 初步问题识别

基于工作流分析，初步识别以下问题类别：

### 8.1 调试效率问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| 工作流执行日志不够清晰 | 难以定位失败节点 | 高 |
| 缺少断点调试能力 | 无法单步执行和变量查看 | 高 |
| 失败重试成本高 | 需要从头执行整个工作流 | 中 |
| 嵌套迭代调试困难 | 37个节点中有多层嵌套 | 中 |

### 8.2 能力卡点问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| 角色一致性控制依赖 LLM 理解 | 跨分镜角色可能不一致 | 高 |
| 视频合成依赖外部 CapCut | 无法在 Dify 内完成完整流程 | 中 |
| 图片生成失败率 | 需要 banana 备选服务 | 中 |
| 视频生成质量不稳定 | i2v 效果受输入图质量影响 | 中 |

### 8.3 流程问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| 工作流节点数量多（37个） | 维护复杂度高 | 中 |
| 外部服务依赖多 | 单点故障风险 | 中 |
| 成本追踪不完善 | 难以评估单次生成成本 | 低 |

---

## 9. 后续工作

### 9.1 Phase 2 剩余任务

| 任务 | 说明 | 方法 |
|------|------|------|
| 2.3 配置人员痛点收集 | 访谈工作流配置人员 | 访谈 |
| 2.4 现有数据/指标分析 | 分析工作流执行日志 | 日志/监控 |

### 9.2 与 Phase 3 的衔接

Phase 3 将基于本文档识别的问题进行：
1. 问题优先级排序（影响矩阵）
2. 根因分析（5-WHY）
3. 能力 Gap 分析（对标业界）
4. 技术方案设计

---

## 附录：参考文档

| 文档 | 说明 |
|------|------|
| `02-dify-platform-capabilities.md` | Dify 平台能力清单 |
| ref-09: dify-courseware-video-workflow-analysis.md | 工作流 DSL 详细分析 |
| huobao-drama 源码 | 业界开源项目参考 |

---

*文档生成时间：2026-02-07*
*数据来源：Dify 工作流 DSL 分析 + 平台源码分析*
